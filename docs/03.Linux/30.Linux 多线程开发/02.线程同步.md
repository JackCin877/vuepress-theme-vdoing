---
title: çº¿ç¨‹åŒæ­¥
date: 2023-09-12 17:03:37
permalink: /pages/a26656/
categories:
  - Linux
  - Linux å¤šçº¿ç¨‹å¼€å‘
tags:
  - 
author: 
  name: JackCin
  link: https://github.com/JackCin877
---
# çº¿ç¨‹åŒæ­¥

## 1ã€çº¿ç¨‹åŒæ­¥

### 1.1 çº¿ç¨‹åŒæ­¥æ¦‚å¿µ

* **çº¿ç¨‹çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºï¼Œèƒ½å¤Ÿé€šè¿‡å…¨å±€å˜é‡æ¥å…±äº«ä¿¡æ¯**ã€‚ä¸è¿‡ï¼Œè¿™ç§ä¾¿æ·çš„å…±äº«æ˜¯æœ‰ä»£ä»·çš„ï¼šå¿…é¡»ç¡®ä¿å¤šä¸ªçº¿ç¨‹ä¸ä¼šåŒæ—¶ä¿®æ”¹åŒä¸€å˜é‡ï¼Œæˆ–è€…æŸä¸€çº¿ç¨‹ä¸ä¼šè¯»å–æ­£åœ¨ç”±å…¶ä»–çº¿ç¨‹ä¿®æ”¹çš„å˜é‡ã€‚ 
* **ä¸´ç•ŒåŒºæ˜¯æŒ‡è®¿é—®æŸä¸€å…±äº«èµ„æºçš„ä»£ç ç‰‡æ®µï¼Œå¹¶ä¸”è¿™æ®µä»£ç çš„æ‰§è¡Œåº”ä¸ºåŸå­æ“ä½œï¼ˆå¿…é¡»ä¸€å£æ°”æ‰§è¡Œå®Œä¸èƒ½æ‰§è¡Œä¸€åŠè¢«ä¸­æ–­ï¼‰ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶è®¿é—®åŒä¸€å…±äº«èµ„æºçš„å…¶ä»–çº¿ç¨‹ä¸åº”ä¸­æ–­è¯¥ç‰‡æ®µçš„æ‰§è¡Œ**ã€‚ 
* **çº¿ç¨‹åŒæ­¥**ï¼šå³å½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å¯¹å†…å­˜è¿›è¡Œæ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¸å¯ä»¥å¯¹è¿™ä¸ªå†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œç›´åˆ°è¯¥çº¿ç¨‹å®Œæˆæ“ä½œï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½å¯¹è¯¥å†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œè€Œå…¶ä»–çº¿ç¨‹åˆ™å¤„äºç­‰å¾…çŠ¶æ€ã€‚

### 1.2 çº¿ç¨‹åŒæ­¥åº”ç”¨åœºæ™¯

```c
/*
    ä½¿ç”¨å¤šçº¿ç¨‹å®ç°ä¹°ç¥¨çš„æ¡ˆä¾‹ã€‚
    æœ‰3ä¸ªçª—å£ï¼Œä¸€å…±æ˜¯100å¼ ç¥¨ã€‚
*/

#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

// å…¨å±€å˜é‡ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å…±äº«è¿™ä¸€ä»½èµ„æºã€‚
int tickets = 100;

void *sellticket(void *arg)
{
    // å–ç¥¨
    while (tickets > 0)
    {
        // ä¼‘çœ 1000å¾®ç§’
        usleep(1000);
        printf("%ld æ­£åœ¨å–ç¬¬ %d å¼ é—¨ç¥¨\n", pthread_self(), tickets);
        tickets--;
    }
    return NULL;
}

int main()
{

    // åµåˆ›å»º3ä¸ªå­è¿›ç¨‹
    pthread_t tid1, tid2, tid3;
    pthread_create(&tid1, NULL, sellticket, NULL);
    pthread_create(&tid2, NULL, sellticket, NULL);
    pthread_create(&tid3, NULL, sellticket, NULL);

    // å›æ”¶å­çº¿ç¨‹çš„èµ„æºï¼Œé˜»å¡
    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);
    pthread_join(tid3, NULL);

    // è®¾ç½®çº¿ç¨‹åˆ†ç¦»ã€‚
    // pthread_detach(tid1);
    // pthread_detach(tid2);
    // pthread_detach(tid3);

    pthread_exit(NULL); // é€€å‡ºä¸»çº¿ç¨‹

    return 0;
}
```

![çº¿ç¨‹åŒæ­¥é—®é¢˜](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/çº¿ç¨‹åŒæ­¥é—®é¢˜.6j3oqbt45880.webp)

* å¯ä»¥çœ‹åˆ°å‡ºç°äº†3ä¸ªçº¿ç¨‹å–åŒä¸€å¼ ç¥¨æˆ–è€…ï¼Œå‡ºç°è´Ÿç¥¨çš„æƒ…å†µ
* å–åŒä¸€å¼ ç¥¨ï¼š å‡ ä¸ªçº¿ç¨‹éƒ½è¿›å…¥äº†å¾ªç¯ï¼Œä½†æ˜¯å†æ‰§è¡Œåˆ°ç¥¨æ•°å‡å°‘çš„è¯­å¥å‰ï¼Œçº¿ç¨‹åˆ‡æ¢æ‰§è¡Œï¼Œæ²¡æœ‰å‡å°‘ç¥¨æ•°ï¼Œå¯¼è‡´è¯´å‡ ä¸ªçº¿ç¨‹å–å‡ºäº†åŒä¸€å¼ ç¥¨
* è´Ÿç¥¨ï¼šå‡ ä¸ªçº¿ç¨‹åœ¨è¿˜æœ‰ç¥¨æ•°æ—¶è¿›å…¥äº†å¾ªç¯ï¼Œä½†æ˜¯çº¿ç¨‹åˆ‡æ¢æ‰§è¡Œï¼Œå¯¼è‡´ç¥¨æ•°å‡å°‘åˆ°è´Ÿï¼Œä½†æ˜¯å·²ç»è¿›å…¥å¾ªç¯äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šå–å‡ºç¥¨

> * ä¸Šé¢ä»£ç å¹¶ä¸æ˜¯è¯´æ˜¯å› ä¸ºåŠ äº†ä¼‘çœ æ‰ä¼šå‡ºç°é—®é¢˜ï¼Œåªæ˜¯åŠ äº†ä¼‘çœ é—®é¢˜æ›´æ˜æ˜¾ï¼Œæ‰€ä»¥åŠ äº†ä¼‘çœ ï¼Œä½†æ˜¯å³ä½¿æˆ‘ä»¬ä¸åŠ ä¼‘çœ å°±ä¸ä¼šå‡ºé—®é¢˜ï¼Œä¸ºäº†ä»£ç çš„å¥å£®æ€§ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿåº”è¯¥è€ƒè™‘çº¿ç¨‹åŒæ­¥æ¥è§£å†³ä¸Šè¿°é—®é¢˜

## 2ã€äº’æ–¥é”

### 2.1 äº’æ–¥é‡æ¦‚å¿µ

* ä¸ºé¿å…çº¿ç¨‹æ›´æ–°å…±äº«å˜é‡æ—¶å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨**`äº’æ–¥é‡`**ï¼ˆmutex æ˜¯ mutual exclusion çš„ç¼©å†™ï¼‰æ¥ç¡®ä¿åŒæ—¶ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®æŸé¡¹å…±äº«èµ„æºã€‚å¯ä»¥ä½¿ç”¨äº’æ–¥é‡æ¥ä¿è¯å¯¹ä»»æ„å…±äº«èµ„æºçš„åŸå­è®¿é—®ã€‚ 
* äº’æ–¥é‡æœ‰ä¸¤ç§çŠ¶æ€ï¼š**å·²é”å®š**ï¼ˆlockedï¼‰å’Œ**æœªé”å®š**ï¼ˆunlockedï¼‰ã€‚ä»»ä½•æ—¶å€™ï¼Œè‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥é”å®šè¯¥äº’æ–¥é‡ã€‚è¯•å›¾å¯¹å·²ç»é”å®šçš„æŸä¸€äº’æ–¥é‡å†æ¬¡åŠ é”ï¼Œå°†å¯èƒ½é˜»å¡çº¿ç¨‹æˆ–è€…æŠ¥é”™å¤±è´¥ï¼Œå…·ä½“å–å†³äºåŠ é”æ—¶ä½¿ç”¨çš„æ–¹æ³•ã€‚ 
* ä¸€æ—¦çº¿ç¨‹é”å®šäº’æ–¥é‡ï¼Œéšå³æˆä¸ºè¯¥äº’æ–¥é‡çš„æ‰€æœ‰è€…ï¼Œåªæœ‰æ‰€æœ‰è€…æ‰èƒ½ç»™äº’æ–¥é‡è§£é”ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹æ¯ä¸€å…±äº«èµ„æºï¼ˆå¯èƒ½ç”±å¤šä¸ªç›¸å…³å˜é‡ç»„æˆï¼‰ä¼šä½¿ç”¨ä¸åŒçš„äº’æ–¥é‡ï¼Œæ¯ä¸€çº¿ç¨‹åœ¨è®¿é—®åŒä¸€èµ„æºæ—¶å°†é‡‡ç”¨å¦‚ä¸‹åè®®ï¼š 
  * **é’ˆå¯¹å…±äº«èµ„æºé”å®šäº’æ–¥é‡** 
  * **è®¿é—®å…±äº«èµ„æº** 
  * **å¯¹äº’æ–¥é‡è§£é”**

![äº’æ–¥é‡å›¾è§£](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/äº’æ–¥é‡å›¾è§£.4w1ge1avlzc0.webp)



### 2.2 äº’æ–¥é‡å‡½æ•°

```c
//äº’æ–¥é‡çš„ç±»å‹ pthread_mutex_t
int pthread_mutex_init(pthread_mutex_t *restrict mutex, const pthread_mutexattr_t *restrict attr);
    - åˆå§‹åŒ–äº’æ–¥é‡
    - å‚æ•° ï¼š
        - mutex ï¼š éœ€è¦åˆå§‹åŒ–çš„äº’æ–¥é‡å˜é‡
        - attr ï¼š äº’æ–¥é‡ç›¸å…³çš„å±æ€§ï¼ŒNULL
    - restrict : Cè¯­è¨€çš„ä¿®é¥°ç¬¦ï¼Œè¢«ä¿®é¥°çš„æŒ‡é’ˆï¼Œä¸èƒ½ç”±å¦å¤–çš„ä¸€ä¸ªæŒ‡é’ˆè¿›è¡Œæ“ä½œã€‚å¦‚ï¼š
        pthread_mutex_t *restrict mutex = xxx;
        pthread_mutex_t * mutex1 = mutex; //è¿™æ ·æ˜¯ä¸å¯ä»¥çš„ï¼Œå› ä¸ºmutex å·²ç»è¢« restrictä¿®é¥°

int pthread_mutex_destroy(pthread_mutex_t *mutex);
    - é‡Šæ”¾äº’æ–¥é‡çš„èµ„æº
int pthread_mutex_lock(pthread_mutex_t *mutex);
    - åŠ é”ï¼Œé˜»å¡çš„ï¼Œå¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹åŠ é”äº†ï¼Œé‚£ä¹ˆå…¶ä»–çš„çº¿ç¨‹åªèƒ½é˜»å¡ç­‰å¾…
int pthread_mutex_trylock(pthread_mutex_t *mutex);
    - å°è¯•åŠ é”ï¼Œå¦‚æœåŠ é”å¤±è´¥ï¼Œä¸ä¼šé˜»å¡ï¼Œä¼šæ¥ç€æ‰§è¡Œä¹‹åçš„ä»£ç ã€‚
    - å¦‚æœåŠ é”æˆåŠŸï¼Œä¼šè®¿é—®ä¸´ç•Œèµ„æº
int pthread_mutex_unlock(pthread_mutex_t *mutex);
    - è§£é”
```

* è¡¥å……ï¼š[pthread_mutex_trylock_æœ‰æœ‹å±±äººçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/cgb165937385/article/details/12648893/?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0--blog-89362179.235^v32^pc_relevant_default_base3&spm=1001.2101.3001.4242.1&utm_relevant_index=3)

### 2.3 äº’æ–¥é‡å®ç°çº¿ç¨‹åŒæ­¥

```c
//mutex.c

#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

// å…¨å±€å˜é‡ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å…±äº«è¿™ä¸€ä»½èµ„æºã€‚
int tickets = 1000;
// åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡(å…¨å±€å˜é‡)
pthread_mutex_t mutex;

void *sellticket(void *arg)
{
    // å–ç¥¨
    while (1)
    {
        // åŠ é”
        pthread_mutex_lock(&mutex);
        // ä¸‹é¢çš„æ“ä½œå°±æ˜¯æˆ‘ä»¬çš„ä¸´ç•ŒåŒº
        if (tickets > 0)
        {
            usleep(6000);
            printf("%ld æ­£åœ¨å–ç¬¬ %d å¼ é—¨ç¥¨\n", pthread_self(), tickets);
            tickets--;
        }
        else
        {
            // è§£é”ï¼ˆè¿™é‡Œä¹Ÿå¿…é¡»è§£é”ï¼Œä¸ç„¶å¦‚æœç›´æ¥å°±è·³å‡ºæ¥å¾ªç¯ï¼Œä¼šå¯¼è‡´äº’æ–¥é‡ä¸€ç›´è¢«å ç”¨ï¼Œæ²¡æœ‰è§£é”ï¼‰
            pthread_mutex_unlock(&mutex);
            break;
        }

        // è§£é”
        pthread_mutex_unlock(&mutex);
    }
    return NULL;
}

int main()
{
    // åˆå§‹åŒ–äº’æ–¥é‡
    pthread_mutex_init(&mutex, NULL);

    // åˆ›å»º3ä¸ªå­çº¿ç¨‹
    pthread_t tid1, tid2, tid3;
    pthread_create(&tid1, NULL, sellticket, NULL);
    pthread_create(&tid2, NULL, sellticket, NULL);
    pthread_create(&tid3, NULL, sellticket, NULL);

    // å›æ”¶å­çº¿ç¨‹çš„èµ„æº,é˜»å¡
    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);
    pthread_join(tid3, NULL);
    
    // é‡Šæ”¾äº’æ–¥é‡èµ„æºï¼ˆjoinä¼šé˜»å¡ï¼Œæ‰€ä»¥ä¼šç­‰å­è¿›ç¨‹éƒ½ç»“æŸæ‰é‡Šæ”¾ï¼‰
    pthread_mutex_destroy(&mutex);
    
    pthread_exit(NULL); // é€€å‡ºä¸»çº¿ç¨‹
    return 0;
}
```

## 3ã€æ­»é”

### 3.1 æ­»é”æ¦‚å¿µ

* æœ‰æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è®¿é—®ä¸¤ä¸ªæˆ–æ›´å¤šä¸åŒçš„å…±äº«èµ„æºï¼Œè€Œæ¯ä¸ªèµ„æºåˆéƒ½ç”±ä¸åŒçš„äº’æ–¥é‡ç®¡ç†ã€‚å½“è¶…è¿‡ä¸€ä¸ªçº¿ç¨‹åŠ é”åŒä¸€ç»„äº’æ–¥é‡æ—¶ï¼Œå°±æœ‰å¯èƒ½å‘ç”Ÿæ­»é”ã€‚ 
* ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºå…±äº«èµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ã€‚ 
* æ­»é”çš„å‡ ç§åœºæ™¯ï¼š 
  * **å¿˜è®°é‡Šæ”¾é”** 
  * **é‡å¤åŠ é”** 
  * **å¤šçº¿ç¨‹å¤šé”ï¼ŒæŠ¢å é”èµ„æº**



### 3.2 æ­»é”äº§ç”Ÿåœºæ™¯

#### 3.2.1 å¿˜è®°é‡Šæ”¾é”

```c
//mutex.c

void *sellticket(void *arg)
{
    // å–ç¥¨
    while (1)
    {
        // åŠ é”
        pthread_mutex_lock(&mutex);
        // ä¸‹é¢çš„æ“ä½œå°±æ˜¯æˆ‘ä»¬çš„ä¸´ç•ŒåŒº
        if (tickets > 0)
        {
            usleep(6000);
            printf("%ld æ­£åœ¨å–ç¬¬ %d å¼ é—¨ç¥¨\n", pthread_self(), tickets);
            tickets--;
        }
        else
        {
            // è§£é”ï¼ˆå¦‚æœç›´æ¥å°±è·³å‡ºæ¥å¾ªç¯ï¼Œä¼šå¯¼è‡´äº’æ–¥é‡ä¸€ç›´è¢«å ç”¨ï¼Œæ²¡æœ‰è§£é”ï¼‰
            pthread_mutex_unlock(&mutex);
            break;
        }
        // è§£é”
        //pthread_mutex_unlock(&mutex);
    }
    return NULL;
}
```

* ä¸Šé¢ä»£ç è¿è¡Œç»“æœä¸ºï¼š `æ­£åœ¨å–ç¬¬ 1000 å¼ é—¨ç¥¨` å¦‚æœå°±è¢«é˜»å¡äº†ï¼Œå› ä¸ºå®ƒå¿˜è®°è§£é”ï¼Œå†æ¬¡æ‰§è¡Œå°±å¯¼è‡´äº†é‡å¤åŠ é”ï¼Œæ‰€ä»¥çº¿ç¨‹è¢«é˜»å¡

#### 3.2.2 é‡å¤åŠ é”

```c
void *sellticket(void *arg)
{
    // å–ç¥¨
    while (1)
    {
        // åŠ é”
        pthread_mutex_lock(&mutex);
        pthread_mutex_lock(&mutex);
        // ä¸‹é¢çš„æ“ä½œå°±æ˜¯æˆ‘ä»¬çš„ä¸´ç•ŒåŒº
        if (tickets > 0)
        {
            usleep(6000);
            printf("%ld æ­£åœ¨å–ç¬¬ %d å¼ é—¨ç¥¨\n", pthread_self(), tickets);
            tickets--;
        }
        else
        {
            // è§£é”ï¼ˆå¦‚æœç›´æ¥å°±è·³å‡ºæ¥å¾ªç¯ï¼Œä¼šå¯¼è‡´äº’æ–¥é‡ä¸€ç›´è¢«å ç”¨ï¼Œæ²¡æœ‰è§£é”ï¼‰
            pthread_mutex_unlock(&mutex);
            break;
        }
        // è§£é”
        pthread_mutex_unlock(&mutex);
        pthread_mutex_unlock(&mutex);
    }
    return NULL;
}
```

* ä¸Šé¢ä»£ç è¿è¡Œç»“æœæ˜¯ç›´æ¥è¢«é˜»å¡ä¸Šé¢ä¹Ÿæ²¡è¾“å‡ºï¼Œå› ä¸ºé‡å¤åŠ é”ï¼Œå¯¼è‡´äº†çº¿ç¨‹è¢«é˜»å¡

#### 3.2.3 å¤šçº¿ç¨‹å¤šé”ï¼ŒæŠ¢å é”èµ„æº

```c
#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

// åˆ›å»º2ä¸ªäº’æ–¥é‡
pthread_mutex_t mutex1, mutex2;

void *workA(void *arg)
{

    pthread_mutex_lock(&mutex1);
    sleep(1);
    pthread_mutex_lock(&mutex2);

    printf("workA....\n");
    // æ³¨æ„è§£é”é¡ºåºï¼Œå…ˆé”åè§£ï¼Œåé”å…ˆè§£
    pthread_mutex_unlock(&mutex2);
    pthread_mutex_unlock(&mutex1);
    return NULL;
}

void *workB(void *arg)
{
    pthread_mutex_lock(&mutex2);
    sleep(1);
    pthread_mutex_lock(&mutex1);

    printf("workB....\n");

    pthread_mutex_unlock(&mutex1);
    pthread_mutex_unlock(&mutex2);

    return NULL;
}

int main()
{

    // åˆå§‹åŒ–äº’æ–¥é‡
    pthread_mutex_init(&mutex1, NULL);
    pthread_mutex_init(&mutex2, NULL);

    // åˆ›å»º2ä¸ªå­çº¿ç¨‹
    pthread_t tid1, tid2;
    pthread_create(&tid1, NULL, workA, NULL);
    pthread_create(&tid2, NULL, workB, NULL);

    // å›æ”¶å­çº¿ç¨‹èµ„æº
    pthread_join(tid1, NULL); //ä¼šé˜»å¡ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
    pthread_join(tid2, NULL);

    // é‡Šæ”¾äº’æ–¥é‡èµ„æº
    pthread_mutex_destroy(&mutex1);
    pthread_mutex_destroy(&mutex2);

    return 0;
}
```

![æŠ¢å é”èµ„æº](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/æŠ¢å é”èµ„æº.1axut4sj1vj4.webp)

* åŠ sleep æ˜¯ä¸ºäº†æ›´å¥½çš„è¡¨ç°å‡ºå¤šçº¿ç¨‹å¤šé”ï¼ŒæŠ¢å é”èµ„æºçš„æ•ˆæœï¼Œæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šå«ä¹‰
* å¯ä»¥çœ‹åˆ°åé¢çš„æ‰§è¡Œå°±æ˜¯äº§ç”Ÿäº†æ­»é”



### 3.3 æ€è€ƒ

* ä¸ºä»€ä¹ˆè§£é”é¡ºåºè¦å…ˆé”åè§£ï¼Œåé”å…ˆè§£ï¼Ÿ

> ç­”ï¼šå› ä¸ºä¼šç»™æ­»é”åˆ›é€ æ¡ä»¶ï¼Œå‡è®¾æŒ‰ç…§ åŠ é”1-åŠ é”2-è§£é”1-è§£é”2 çš„è¯ï¼Œçº¿ç¨‹Aåœ¨æ‰§è¡Œå®Œè§£é”1æ—¶ï¼Œå¯èƒ½çº¿ç¨‹Bç«‹åˆ»æ‰§è¡ŒåŠ é”1ï¼Œæ­¤æ—¶çº¿ç¨‹AæŒæœ‰äº’æ–¥é”2ï¼Œè€Œçº¿ç¨‹BæŒæœ‰äº’æ–¥é”1ï¼Œè¿™ä¸ªæ—¶å€™å°±ç¬¦åˆæ­»é”çš„æ•ˆæœå›¾ï¼Ÿ

![æŠ¢å é”èµ„æºå›¾](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/æŠ¢å é”èµ„æºå›¾.5ictmpuz1680.webp)

## 4ã€è¯»å†™é”

### 4.1 è¯»å†™é”æ¦‚å¿µ

* **å½“æœ‰ä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº’æ–¥é”æ—¶ï¼Œäº’æ–¥é”å°†æ‰€æœ‰è¯•å›¾è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹éƒ½é˜»å¡ä½**ã€‚ä½†æ˜¯è€ƒè™‘ä¸€ç§æƒ…å½¢ï¼Œå½“å‰æŒæœ‰äº’æ–¥é”çš„çº¿ç¨‹åªæ˜¯è¦è¯»è®¿é—®å…±äº«èµ„æºï¼Œè€ŒåŒæ—¶æœ‰å…¶å®ƒå‡ ä¸ªçº¿ç¨‹ä¹Ÿæƒ³è¯»å–è¿™ä¸ªå…±äº«èµ„æºï¼Œä½†æ˜¯ç”±äºäº’æ–¥é”çš„æ’å®ƒæ€§ï¼Œæ‰€æœ‰å…¶å®ƒçº¿ç¨‹éƒ½æ— æ³•è·å–é”ï¼Œä¹Ÿå°±æ— æ³•è¯»è®¿é—®å…±äº«èµ„æºäº†ï¼Œä½†æ˜¯å®é™…ä¸Šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»è®¿é—®å…±äº«èµ„æºå¹¶ä¸ä¼šå¯¼è‡´é—®é¢˜ã€‚ 
* åœ¨å¯¹æ•°æ®çš„è¯»å†™æ“ä½œä¸­ï¼Œæ›´å¤šçš„æ˜¯è¯»æ“ä½œï¼Œå†™æ“ä½œè¾ƒå°‘ï¼Œä¾‹å¦‚å¯¹æ•°æ®åº“æ•°æ®çš„è¯»å†™åº”ç”¨ã€‚ ä¸ºäº†æ»¡è¶³å½“å‰èƒ½å¤Ÿ**å…è®¸å¤šä¸ªè¯»å‡ºï¼Œä½†åªå…è®¸ä¸€ä¸ªå†™å…¥çš„éœ€æ±‚ï¼Œçº¿ç¨‹æä¾›äº†è¯»å†™é”æ¥å®ç°**ã€‚ 
* **è¯»å†™é”çš„ç‰¹ç‚¹**ï¼š 
  * å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹è¯»æ•°æ®ï¼Œåˆ™å…è®¸å…¶å®ƒçº¿ç¨‹æ‰§è¡Œè¯»æ“ä½œï¼Œä½†ä¸å…è®¸å†™æ“ä½œã€‚ 
  * å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹å†™æ•°æ®ï¼Œåˆ™å…¶å®ƒçº¿ç¨‹éƒ½ä¸å…è®¸è¯»ã€å†™æ“ä½œã€‚ 
  * å†™æ˜¯ç‹¬å çš„ï¼Œå†™çš„ä¼˜å…ˆçº§é«˜ã€‚



### 4.2 è¯»å†™é”ç›¸å…³å‡½æ•°

```c
    // è¯»å†™é”çš„ç±»å‹ pthread_rwlock_t
    int pthread_rwlock_init(pthread_rwlock_t *restrict rwlock, const pthread_rwlockattr_t *restrict attr);
    int pthread_rwlock_destroy(pthread_rwlock_t *rwlock);
    int pthread_rwlock_rdlock(pthread_rwlock_t *rwlock);
    int pthread_rwlock_tryrdlock(pthread_rwlock_t *rwlock);
    int pthread_rwlock_wrlock(pthread_rwlock_t *rwlock);
    int pthread_rwlock_trywrlock(pthread_rwlock_t *rwlock);
    int pthread_rwlock_unlock(pthread_rwlock_t *rwlock);

//å‡½æ•°ä½œç”¨å’Œå‚æ•°å«ä¹‰åŸºæœ¬å’Œäº’æ–¥é”å·®ä¸å¤š
```

4.3 ä»£ç æ¡ˆä¾‹

```c
//rwlock.c
/*
    æ¡ˆä¾‹ï¼š8ä¸ªçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªå…¨å±€å˜é‡ã€‚
    3ä¸ªçº¿ç¨‹ä¸å®šæ—¶å†™è¿™ä¸ªå…¨å±€å˜é‡ï¼Œ5ä¸ªçº¿ç¨‹ä¸å®šæ—¶çš„è¯»è¿™ä¸ªå…¨å±€å˜é‡
*/

#include <stdio.h>
#include <pthread.h>
#include <unistd.h>

// åˆ›å»ºä¸€ä¸ªå…±äº«æ•°æ®
int num = 1;
pthread_rwlock_t rwlock;
// pthread_mutex_t mutex;

void *writeNum(void *arg)
{

    while (1)
    {
        pthread_rwlock_wrlock(&rwlock);
        // pthread_mutex_lock(&mutex);
        num++;
        printf("++write, tid : %ld, num : %d\n", pthread_self(), num);
        // pthread_mutex_unlock(&mutex);
        pthread_rwlock_unlock(&rwlock);
        usleep(100);
    }

    return NULL;
}

void *readNum(void *arg)
{

    while (1)
    {
        // pthread_mutex_lock(&mutex);
        pthread_rwlock_rdlock(&rwlock);
        printf("===read, tid : %ld, num : %d\n", pthread_self(), num);
        // pthread_mutex_unlock(&mutex);
        pthread_rwlock_unlock(&rwlock);
        usleep(100);
    }

    return NULL;
}

int main()
{
    // pthread_mutex_init(&mutex, NULL);
    pthread_rwlock_init(&rwlock, NULL);

    // åˆ›å»º3ä¸ªå†™çº¿ç¨‹ï¼Œ5ä¸ªè¯»çº¿ç¨‹
    pthread_t wtids[3], rtids[5];
    for (int i = 0; i < 3; i++)
    {
        pthread_create(&wtids[i], NULL, writeNum, NULL);
    }

    for (int i = 0; i < 5; i++)
    {
        pthread_create(&rtids[i], NULL, readNum, NULL);
    }

    // è®¾ç½®çº¿ç¨‹åˆ†ç¦»
    for (int i = 0; i < 3; i++)
    {
        pthread_detach(wtids[i]);
    }

    for (int i = 0; i < 5; i++)
    {
        // è¿™é‡Œæœ€å¥½è¿˜æ˜¯ç”¨ join ï¼Œå› ä¸ºç”¨detachçš„è¯æ˜¯ä¸é˜»å¡çš„
        // ç„¶åæŒ‰ä¸‹é¢ç»ˆæ­¢ä¸»çº¿ç¨‹å’Œé‡Šæ”¾é”çš„é¡ºåºï¼Œå¦‚æœå…ˆç»ˆæ­¢ï¼Œé‚£é‡Šæ”¾å°±æ²¡æ‰§è¡Œ
        // å¦‚æœå…ˆé‡Šæ”¾ï¼Œé‚£å¯èƒ½ä¼šå› ä¸ºå­çº¿ç¨‹è¿˜æ²¡ç»ˆæ­¢ï¼Œå´æå‰é‡Šæ”¾é”è€Œå‡ºç°é—®é¢˜ï¼ˆä¸æ˜¯ä¸€å®šä¼šå‡ºé”™ï¼‰
        // æ‰€ä»¥å»ºè®®è¿˜æ˜¯ä½¿ç”¨joinæ¯”è¾ƒå¥½
        // çªç„¶è§‰å¾—è¿™é‡Œä¹Ÿè›®å¥‡æ€ªçš„ï¼Œå› ä¸ºå­çº¿ç¨‹æ˜¯æ­»å¾ªç¯ä¸ä¼šç»ˆæ­¢ï¼Œå¦‚æœç”¨joiné‚£ä¸»çº¿ç¨‹ä¹Ÿä¸ä¼šè‡ªåŠ¨ç»ˆæ­¢ï¼Œè€Œæ˜¯åœ¨æˆ‘ä»¬æ‰‹åŠ¨ctrl+c ç»ˆæ­¢å­çº¿ç¨‹åæ‰ä¼šç»ˆæ­¢
        pthread_detach(rtids[i]);
    }
    
    //çœ‹åˆ°åé¢çŸ¥é“äº†ï¼Œè€å¸ˆè§£å†³ä¸Šé¢é—®é¢˜çš„æ–¹æ³•å±…ç„¶æ˜¯ç”¨whileä¸è®©ä¸»çº¿ç¨‹é€€å‡ºğŸ¤•ğŸ¤•ğŸ¤•ï¼Œè¿˜æ˜¯å»ºè®®ç”¨joinæ¯”è¾ƒå¥½
    while(1) {
        sleep(10);
    }
    
    

    pthread_exit(NULL);
	//å…ˆæ‰§è¡Œäº† pthread_exit(NULL) åé¢çš„è¯­å¥ç›¸å½“äºæ²¡æ‰§è¡Œï¼Œæ„Ÿè§‰è€å¸ˆè¿™æ ·å†™çš„é¡ºåºä¸å¯¹
    pthread_rwlock_destroy(&rwlock);
    // pthread_mutex_destroy(&mutex);

    return 0;
}
```

![è¯»å†™é”](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/è¯»å†™é”.3vg08xv5mn80.webp)

* å…¶å®è¿™é‡Œå°±æ˜¯æˆ‘ä»¬ä¸æ˜¯ç”¨çš„è¯»å†™é”è€Œæ˜¯äº’æ–¥é”ï¼Œæ‰§è¡Œç»“æœéƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯**ä½¿ç”¨äº’æ–¥é”çš„è¯ï¼Œè¿›è¡Œè¯»å–çš„çº¿ç¨‹å¹¶ä¸æ˜¯å¹¶å‘æ‰§è¡Œçš„**ï¼Œè€Œæ˜¯é˜»å¡çš„ï¼Œä¸€ä¸ªæ‰§è¡Œå®Œè§£äº†é”ï¼Œä¸‹ä¸€ä¸ªæ‰èƒ½æ‰§è¡Œã€‚

## 5ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹

### 5.1 ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

* ç³»ç»Ÿä¸­æœ‰ä¸€ç»„ç”Ÿäº§è€…è¿›ç¨‹å’Œä¸€ç»„æ¶ˆè´¹è€…è¿›ç¨‹ã€‚ç”Ÿäº§è€…è¿›ç¨‹æ¯æ¬¡ç”Ÿäº§ä¸€ä¸ªäº§å“æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…è¿›ç¨‹æ¯æ¬¡ä»ç¼“å†²åŒºä¸­å–å‡ºä¸€ä¸ªè¿›ç¨‹å¹¶ä½¿ç”¨ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹é—´å…·æœ‰è¿™æ ·ä¸€å±‚å…³ç³»ï¼š
* ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…å…±äº«ä¸€ä¸ªåˆå§‹ä¸ºç©ºã€å¤§å°ä¸ºnçš„ç¼“å†²åŒºã€‚
  * åªæœ‰ç¼“å†²åŒºæ²¡æ»¡æ—¶ï¼Œç”Ÿäº§è€…æ‰èƒ½æŠŠäº§å“æ”¾å…¥ç¼“å†²åŒºã€‚å¦åˆ™å¿…é¡»ç­‰å¾… (ç¼“å†²åŒºæ²¡æ»¡->ç”Ÿäº§è€…ç”Ÿäº§)
  * åªæœ‰ç¼“å†²åŒºä¸ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…æ‰èƒ½ä»ä¸­å–å‡ºäº§å“ï¼Œå¦åˆ™å¿…é¡»ç­‰å¾… (ç¼“å†²åŒºä¸ç©º->æ¶ˆè´¹è€…æ¶ˆè´¹)
  * ç¼“å†²åŒºæ˜¯ä¸´ç•Œèµ„æºï¼Œå„è¿›ç¨‹è®¿é—®æ—¶è¦æ±‚äº’æ–¥ (äº’æ–¥è®¿é—®)

![img](https://images2015.cnblogs.com/blog/868641/201703/868641-20170303152707641-1755807475.png)

### 5.2 ä»£ç æ¨¡æ‹Ÿ

```c
//prodcust.c
/*
    ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆç²—ç•¥çš„ç‰ˆæœ¬ï¼‰
*/
#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>
#include <unistd.h>

struct Node
{
    int num;
    struct Node *next;
};

// å¤´ç»“ç‚¹
struct Node *head = NULL;
void *producer(void *arg)
{
    // ä¸æ–­çš„åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é“¾è¡¨ä¸­
    while (1)
    {
        //è¿™é‡Œç”¨çš„æ˜¯å¤´æ’æ³•
        struct Node *newNode = (struct Node *)malloc(sizeof(struct Node));
        newNode->next = head;
        head = newNode;
        newNode->num = rand() % 1000;
        printf("add node, num : %d, tid : %ld\n", newNode->num, pthread_self());
        usleep(100);
    }

    return NULL;
}

void *customer(void *arg)
{

    while (1)
    {
        // ä¿å­˜å¤´ç»“ç‚¹çš„æŒ‡é’ˆ
        struct Node *tmp = head;
        head = head->next;
        printf("del node, num : %d, tid : %ld\n", tmp->num, pthread_self());
        free(tmp);
        usleep(100);
    }
    return NULL;
}

int main()
{

    // åˆ›å»º5ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œå’Œ5ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹
    pthread_t ptids[5], ctids[5];

    for (int i = 0; i < 5; i++)
    {
        pthread_create(&ptids[i], NULL, producer, NULL);
        pthread_create(&ctids[i], NULL, customer, NULL);
    }

    for (int i = 0; i < 5; i++)
    {
        pthread_detach(ptids[i]);
        pthread_detach(ctids[i]);
    }

    while (1)
    {
        sleep(10);
    }

    pthread_exit(NULL);

    return 0;
}
```

![ç”Ÿäº§æ¶ˆè´¹é—®é¢˜](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ç”Ÿäº§æ¶ˆè´¹é—®é¢˜.5ytkr02scb40.webp)

* è¿™é‡Œç¼–è¯‘ç”Ÿæˆ `prodcust å¯æ‰§è¡Œæ–‡ä»¶`æ—¶è®°å¾—åŠ  `-g` ç”Ÿæˆè°ƒè¯•ä¿¡æ¯ï¼Œä¸ç„¶æˆ‘ä»¬æ²¡åŠæ³•æŸ¥çœ‹ `core`

* æŸ¥çœ‹ coreï¼š

  ![ç”Ÿäº§æ¶ˆè´¹é—®é¢˜core](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ç”Ÿäº§æ¶ˆè´¹é—®é¢˜core.vsrbrw3oxrk.webp)

* `SIGSEGV` ï¼šå¯ä»¥çœ‹å‡ºè¿›è¡Œäº†æ— æ•ˆå†…å­˜è®¿é—®ï¼ˆæ®µé”™è¯¯ï¼‰
* åŸå› å°±æ˜¯å½“æˆ‘ä»¬é“¾è¡¨è¢«åˆ é™¤å®Œåï¼Œå°±æ²¡æœ‰äº†headç»“ç‚¹ï¼Œæ‰€ä»¥ç”Ÿæˆçº¿ç¨‹æ‰§è¡Œåˆ° `head = head->next`è¯­å¥å°±å‡ºç°äº†æ®µé”™è¯¯
* ä¸‹é¢ç»™å‡º3ç§è§£å†³æ–¹æ³•ï¼Œæ³¨æ„ä¸‹é¢3ç§æ–¹æ³•éƒ½æ˜¯éœ€è¦**ç”¨åˆ°äº’æ–¥é‡æˆ–è€…ä¸äº’æ–¥é‡æ­é…ä½¿ç”¨**

### 5.3 äº’æ–¥é”è§£å†³æ–¹æ³•

```c
/*
    ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ˆç²—ç•¥çš„ç‰ˆæœ¬ï¼‰
*/
#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>
#include <unistd.h>

// åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡
pthread_mutex_t mutex;

struct Node{
    int num;
    struct Node *next;
};

// å¤´ç»“ç‚¹
struct Node * head = NULL;

void * producer(void * arg) {

    // ä¸æ–­çš„åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é“¾è¡¨ä¸­
    while(1) {
        pthread_mutex_lock(&mutex);
        //è¿™é‡Œç”¨çš„æ˜¯å¤´æ’æ³•
        struct Node * newNode = (struct Node *)malloc(sizeof(struct Node));
        newNode->next = head;
        head = newNode;
        newNode->num = rand() % 1000;
        printf("add node, num : %d, tid : %ld\n", newNode->num, pthread_self());
        pthread_mutex_unlock(&mutex);
        usleep(100);
    }

    return NULL;
}

void * customer(void * arg) {

    while(1) {
        pthread_mutex_lock(&mutex);
        // ä¿å­˜å¤´ç»“ç‚¹çš„æŒ‡é’ˆ
        struct Node * tmp = head;

        // åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®
       // è¿™æ ·çš„å†™æ³•çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœhead == NULLï¼Œé‚£ä¹ˆå°±ä¼šä¸€ç›´å¾ªç¯åˆ¤æ–­è€Œä¸åšå…¶ä»–äº‹æƒ…ï¼Œè¿™æ ·å¾ˆæµªè´¹èµ„æº
        if(head != NULL) {
            // æœ‰æ•°æ®
            head = head->next;
            printf("del node, num : %d, tid : %ld\n", tmp->num, pthread_self());
            free(tmp);
            pthread_mutex_unlock(&mutex);
            usleep(100);
        } else {
            // æ²¡æœ‰æ•°æ®
            pthread_mutex_unlock(&mutex);
        }
    }
    return  NULL;
}

int main() {

    pthread_mutex_init(&mutex, NULL);

    // åˆ›å»º5ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œå’Œ5ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹
    pthread_t ptids[5], ctids[5];

    for(int i = 0; i < 5; i++) {
        pthread_create(&ptids[i], NULL, producer, NULL);
        pthread_create(&ctids[i], NULL, customer, NULL);
    }

    for(int i = 0; i < 5; i++) {
        pthread_detach(ptids[i]);
        pthread_detach(ctids[i]);
    }

    while(1) {
        sleep(10);
    }

    pthread_mutex_destroy(&mutex);

    pthread_exit(NULL);

    return 0;
}
```

* åªç”¨äº’æ–¥é”è§£å†³çš„å†™æ³•çš„é—®é¢˜æ˜¯ï¼š
  * å½“ç¼“å†²åŒºä¸ºç©ºï¼Œ**ä¸ç”¨æ¡ä»¶å˜é‡æ—¶**ï¼Œæ¶ˆè´¹è€…å¤„äºæ— æ„ä¹‰çš„å¾ªç¯ï¼Œæ­¤æ—¶åªæ‰§è¡ŒåŠ é”å’Œè§£é”ï¼Œç›´åˆ°æ—¶é—´ç‰‡å®Œæ‰å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œæµªè´¹cpuèµ„æºã€‚è€ŒåŠ å…¥æ¡ä»¶å˜é‡ï¼Œä¸€æ—¦å‘ç°ç¼“å­˜åŒºæ˜¯ç©ºçš„ï¼Œä¼šç«‹åˆ»ä»è¿è¡Œæ€è¿›å…¥é˜»å¡æ€ï¼Œæ­¤æ—¶ä¸€å®šä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼ŒæŠŠcpuèµ„æºè®©å‡ºã€‚äº’æ–¥é”å’Œæ¡ä»¶å˜é‡éƒ½å¯ä»¥å®ç°çº¿ç¨‹åŒæ­¥ï¼Œä½†ä½¿ç”¨æ¡ä»¶å˜é‡æ•ˆç‡æ›´é«˜ã€‚

## 6ã€æ¡ä»¶å˜é‡

### 6.1 æ¡ä»¶å˜é‡å‡½æ•°

```c
  //æ¡ä»¶å˜é‡çš„ç±»å‹ pthread_cond_t
    int pthread_cond_init(pthread_cond_t *restrict cond, const pthread_condattr_t *restrict attr);
    int pthread_cond_destroy(pthread_cond_t *cond);
    int pthread_cond_wait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex);
        - ç­‰å¾…ï¼Œè°ƒç”¨äº†è¯¥å‡½æ•°ï¼Œçº¿ç¨‹ä¼šé˜»å¡ã€‚
        - å½“è¿™ä¸ªå‡½æ•°è°ƒç”¨é˜»å¡çš„æ—¶å€™ï¼Œä¼šå¯¹äº’æ–¥é”è¿›è¡Œè§£é”ï¼Œå½“ä¸é˜»å¡çš„ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¼šé‡æ–°åŠ é”ã€‚
    int pthread_cond_timedwait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex, const struct timespec *restrict abstime);
        - ç­‰å¾…å¤šé•¿æ—¶é—´ï¼Œè°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œçº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°æŒ‡å®šçš„æ—¶é—´ç»“æŸã€‚
    int pthread_cond_signal(pthread_cond_t *cond);
        - å”¤é†’ä¸€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…çš„çº¿ç¨‹
    int pthread_cond_broadcast(pthread_cond_t *cond);
        - å”¤é†’æ‰€æœ‰çš„ç­‰å¾…çš„çº¿ç¨‹
```



### 6.2 æ¡ä»¶å˜é‡è§£å†³æ–¹æ³•

```c
//cond.c

#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>
#include <unistd.h>

// åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡
pthread_mutex_t mutex;
// åˆ›å»ºæ¡ä»¶å˜é‡
pthread_cond_t cond;

struct Node
{
    int num;
    struct Node *next;
};

// å¤´ç»“ç‚¹
struct Node *head = NULL;

void *producer(void *arg)
{

    // ä¸æ–­çš„åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é“¾è¡¨ä¸­
    while (1)
    {
        pthread_mutex_lock(&mutex);
        struct Node *newNode = (struct Node *)malloc(sizeof(struct Node));
        newNode->next = head;
        head = newNode;
        newNode->num = rand() % 1000;
        printf("add node, num : %d, tid : %ld\n", newNode->num, pthread_self());

        // åªè¦ç”Ÿäº§äº†ä¸€ä¸ªï¼Œå°±é€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹
        //æ³¨æ„ï¼šsignalæ˜¯å”¤é†’ä¸€ä¸ªæˆ–è€…å¤šä¸ªç¡çœ çš„çº¿ç¨‹ï¼Œå¦‚æœæ•°æ®è¶³å¤Ÿå¤šï¼Œçº¿ç¨‹æ²¡æœ‰ä¼‘çœ ï¼Œå³ä½¿æ”¶åˆ°äº†ä¿¡å·ä¹Ÿä¸ä¼šåšä»»ä½•çš„å¤„ç†ã€‚
        pthread_cond_signal(&cond);

        pthread_mutex_unlock(&mutex);
        usleep(100);
    }

    return NULL;
}

void *customer(void *arg)
{

    while (1)
    {
        pthread_mutex_lock(&mutex);
        // ä¿å­˜å¤´ç»“ç‚¹çš„æŒ‡é’ˆ
        struct Node *tmp = head;
        // åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®
        if (head != NULL)
        {
            // æœ‰æ•°æ®
            head = head->next;
            printf("del node, num : %d, tid : %ld\n", tmp->num, pthread_self());
            free(tmp);
            pthread_mutex_unlock(&mutex);
            usleep(100);
        }
        else
        {
            // æ²¡æœ‰æ•°æ®ï¼Œéœ€è¦ç­‰å¾…
            // å½“è¿™ä¸ªå‡½æ•°è°ƒç”¨é˜»å¡çš„æ—¶å€™ï¼Œä¼šå¯¹äº’æ–¥é”è¿›è¡Œè§£é”ï¼Œå½“ä¸é˜»å¡çš„æ—¶å€™ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œä¼šé‡æ–°åŠ é”ã€‚
            pthread_cond_wait(&cond, &mutex);
            pthread_mutex_unlock(&mutex);
        }
    }
    return NULL;
}

int main()
{
	//åˆå§‹åŒ–äº’æ–¥é”å’Œæ¡ä»¶å˜é‡
    pthread_mutex_init(&mutex, NULL);
    pthread_cond_init(&cond, NULL);

    // åˆ›å»º5ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œå’Œ5ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹
    pthread_t ptids[5], ctids[5];

    for (int i = 0; i < 5; i++)
    {
        pthread_create(&ptids[i], NULL, producer, NULL);
        pthread_create(&ctids[i], NULL, customer, NULL);
    }

    for (int i = 0; i < 5; i++)
    {
        pthread_detach(ptids[i]);
        pthread_detach(ctids[i]);
    }

    while (1)
    {
        sleep(10);
    }

    pthread_mutex_destroy(&mutex);
    pthread_cond_destroy(&cond);

    pthread_exit(NULL);

    return 0;
}

```

* ä½¿ç”¨æ¡ä»¶å˜é‡å°±è§£å†³äº†æˆ‘ä»¬åªç”¨äº’æ–¥é”ï¼Œå¯¼è‡´çš„æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ¶ˆè´¹è€…ä¸€ç›´é‡å¤å¾ªç¯åˆ¤æ–­ï¼Œæµªè´¹èµ„æºçš„é—®é¢˜
* æ³¨æ„ï¼š**å½“çº¿ç¨‹æ‰§è¡Œåˆ°  `pthread_cond_wait(&cond, &mutex)`æ—¶ï¼Œä¼šå¯¹äº’æ–¥é”è¿›è¡Œè§£é”ï¼Œè¿™æ˜¯ç”Ÿäº§è€…å°±å¯ä»¥ç»§ç»­ç”Ÿäº§ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œåˆ°  `pthread_cond_signal(&cond)` ï¼Œå¹¶ä¸”å†æ‰§è¡Œ `pthread_mutex_unlock(&mutex)`è§£é”æ“ä½œåï¼Œé‚£ä¹ˆwaitå°±å–æ¶ˆé˜»å¡çš„åŒæ—¶é‡æ–°åŠ é”ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚**



## 7ã€ä¿¡å·é‡

### 7.1 ä¿¡å·é‡å‡½æ•°

```c
 ä¿¡å·é‡çš„ç±»å‹ sem_t
    int sem_init(sem_t *sem, int pshared, unsigned int value);
        - åˆå§‹åŒ–ä¿¡å·é‡
        - å‚æ•°ï¼š
            - sem : ä¿¡å·é‡å˜é‡çš„åœ°å€
            - pshared : 0 ç”¨åœ¨çº¿ç¨‹é—´ ï¼Œé0 ç”¨åœ¨è¿›ç¨‹é—´
            - value : ä¿¡å·é‡ä¸­çš„å€¼

    int sem_destroy(sem_t *sem);
        - é‡Šæ”¾èµ„æº

    int sem_wait(sem_t *sem);
        - å¯¹ä¿¡å·é‡åŠ é”ï¼Œè°ƒç”¨ä¸€æ¬¡å¯¹ä¿¡å·é‡çš„å€¼-1ï¼Œå¦‚æœå€¼ä¸º0ï¼Œå°±é˜»å¡

    int sem_trywait(sem_t *sem);

    int sem_timedwait(sem_t *sem, const struct timespec *abs_timeout);
		- å¦‚æœæ˜¯0çš„è¯é˜»å¡å¤šé•¿æ—¶é—´
    int sem_post(sem_t *sem);
        - å¯¹ä¿¡å·é‡è§£é”ï¼Œè°ƒç”¨ä¸€æ¬¡å¯¹ä¿¡å·é‡çš„å€¼+1

    int sem_getvalue(sem_t *sem, int *sval);
```

### 7.2 ä¿¡å·é‡ä½¿ç”¨ä¼ªä»£ç 

```c
    sem_t psem; //ç”Ÿäº§è€…ä¿¡å·é‡
    sem_t csem;  //æ¶ˆè´¹è€…ä¿¡å·é‡
    init(psem, 0, 8);  //ç»™ä¸€ä¸ªå€¼å°±è¡Œ
    init(csem, 0, 0);

    producer() {
        sem_wait(&psem);  //å¼€å§‹ç”Ÿäº§ ï¼Œä¸€ä¸ªç”Ÿäº§è€…æ­£åœ¨å·¥ä½œï¼Œæ‰€ä»¥ç”Ÿäº§ä¿¡å· -1
        
        // æ‰§è¡Œä»£ç ï¼ˆç”Ÿäº§ï¼‰
        
        sem_post(&csem)  //ç”Ÿäº§ç»“æŸ ï¼Œæœ‰ä¸€ä¸ªäº§å“å¯ä»¥æ¶ˆè´¹ ï¼Œæ‰€ä»¥æ¶ˆè´¹ä¿¡å· +1
    }

    customer() {
        sem_wait(&csem);  //å¼€å§‹æ¶ˆè´¹ ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…æ­£åœ¨æ¶ˆè´¹ï¼Œæ‰€ä»¥æ¶ˆè´¹ä¿¡å· -1
        
        //æ‰§è¡Œä»£ç ï¼ˆæ¶ˆè´¹ï¼‰
        
        sem_post(&psem)  //æ¶ˆè´¹ç»“æŸ ï¼Œç©ºå‡ºç©ºä½ç»™ç”Ÿäº§è€…è¿›è¡Œç”Ÿäº§ï¼Œç”Ÿäº§ä¿¡å· +1
    }
```

### 7.3 ä¿¡å·é‡è§£å†³æ–¹æ³•

```c
//semaphore.c

#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>
#include <unistd.h>
#include <semaphore.h>

// åˆ›å»ºä¸€ä¸ªäº’æ–¥é‡
pthread_mutex_t mutex;
// åˆ›å»ºä¸¤ä¸ªä¿¡å·é‡
sem_t psem;
sem_t csem;

struct Node
{
    int num;
    struct Node *next;
};

// å¤´ç»“ç‚¹
struct Node *head = NULL;

void *producer(void *arg)
{

    // ä¸æ–­çš„åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°é“¾è¡¨ä¸­
    while (1)
    {
        sem_wait(&psem);
        pthread_mutex_lock(&mutex);
        struct Node *newNode = (struct Node *)malloc(sizeof(struct Node));
        newNode->next = head;
        head = newNode;
        newNode->num = rand() % 1000;
        printf("add node, num : %d, tid : %ld\n", newNode->num, pthread_self());
        pthread_mutex_unlock(&mutex);
        sem_post(&csem);
    }

    return NULL;
}

void *customer(void *arg)
{

    while (1)
    {
        sem_wait(&csem);
        pthread_mutex_lock(&mutex);
        // ä¿å­˜å¤´ç»“ç‚¹çš„æŒ‡é’ˆ
        struct Node *tmp = head;
        head = head->next;
        printf("del node, num : %d, tid : %ld\n", tmp->num, pthread_self());
        free(tmp);
        pthread_mutex_unlock(&mutex);
        sem_post(&psem);
    }
    return NULL;
}

int main()
{

    pthread_mutex_init(&mutex, NULL);
    sem_init(&psem, 0, 8);
    sem_init(&csem, 0, 0);

    // åˆ›å»º5ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œå’Œ5ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹
    pthread_t ptids[5], ctids[5];

    for (int i = 0; i < 5; i++)
    {
        pthread_create(&ptids[i], NULL, producer, NULL);
        pthread_create(&ctids[i], NULL, customer, NULL);
    }

    for (int i = 0; i < 5; i++)
    {
        pthread_detach(ptids[i]);
        pthread_detach(ctids[i]);
    }

    while (1)
    {
        sleep(10);
    }

    pthread_mutex_destroy(&mutex);

    pthread_exit(NULL);

    return 0;
}

```

* **ä¿¡å·é‡ä¸»è¦æ˜¯é˜»å¡çº¿ç¨‹ä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ä¿¡å·é‡è¦å’Œäº’æ–¥é”ä¸€èµ·ä½¿ç”¨**ï¼ˆå¥½æ¯”ä¸Šé¢å¦‚æœä¸ç”¨äº’æ–¥é”ï¼Œå°±å¯èƒ½ä¼šå‡ºç°é“¾è¡¨ç»“ç‚¹åˆ›å»ºä¸€åŠå…¶ä»–çº¿ç¨‹åˆæŠ¢å æ—¶é—´ç‰‡ï¼Œè¿›è¡Œåˆ›å»ºï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´é“¾è¡¨å‡ºé”™ï¼‰



### 7.4 ç”Ÿäº§æ¶ˆè´¹æ­£ç¡®è¿è¡Œ

![è§£å†³ç”Ÿäº§æ¶ˆè´¹é—®é¢˜](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/è§£å†³ç”Ÿäº§æ¶ˆè´¹é—®é¢˜.54xd4t9dkrw0.webp)

* å› ä¸ºæˆ‘ä»¬æ˜¯å¤´æ’æ³•ï¼Œåˆ é™¤ä¹Ÿæ˜¯ä»å¤´èŠ‚ç‚¹å¼€å§‹åˆ ï¼Œæ‰€ä»¥ä¼šæ˜¯ä¸Šå›¾çš„æ ·å­
* ä¸ªäººæ„Ÿè§‰ï¼šï¼ˆä½¿ç”¨ä¿¡å·é‡çš„è¯ï¼Œæ•°æ®é‡å°±æœ‰äº†ä¸Šé™ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡çš„è¯ï¼Œæœ‰äº›åœºæ™¯è¿˜æ˜¯éœ€è¦è‡ªå·±ä»£ç åˆ¤æ–­ï¼‰