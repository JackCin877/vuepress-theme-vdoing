---
title: çº¿ç¨‹åŸºç¡€
date: 2023-09-12 17:03:37
permalink: /pages/92b74a/
categories:
  - Linux
  - Linux å¤šçº¿ç¨‹å¼€å‘
tags:
  - 
author: 
  name: JackCin
  link: https://github.com/JackCin877
---
# çº¿ç¨‹

## 1ã€çº¿ç¨‹æ¦‚è¿°

* ä¸è¿›ç¨‹ï¼ˆprocessï¼‰ç±»ä¼¼ï¼Œçº¿ç¨‹ï¼ˆthreadï¼‰æ˜¯å…è®¸åº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„ä¸€ç§æœºåˆ¶ã€‚**ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹**ã€‚**åŒä¸€ä¸ªç¨‹åºä¸­çš„æ‰€æœ‰çº¿ç¨‹å‡ä¼šç‹¬ç«‹æ‰§è¡Œç›¸åŒç¨‹åºï¼Œä¸”å…±äº«åŒä¸€ä»½å…¨å±€å†…å­˜åŒºåŸŸ**ï¼Œå…¶ä¸­åŒ…æ‹¬åˆå§‹åŒ–æ•°æ®æ®µã€æœªåˆå§‹åŒ–æ•°æ®æ®µï¼Œä»¥åŠå †å†…å­˜æ®µã€‚ï¼ˆä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ UNIX è¿›ç¨‹åªæ˜¯å¤šçº¿ç¨‹ç¨‹åºçš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œè¯¥è¿›ç¨‹åªåŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼‰ 
* **è¿›ç¨‹æ˜¯ CPU åˆ†é…èµ„æºçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦æ‰§è¡Œçš„æœ€å°å•ä½**ã€‚ 
* çº¿ç¨‹æ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼ˆLWPï¼šLight Weight Processï¼‰ï¼Œåœ¨ Linux ç¯å¢ƒä¸‹çº¿ç¨‹çš„æœ¬ è´¨ä»æ˜¯è¿›ç¨‹ã€‚ 
* æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„ LWP å·ï¼š`ps â€“Lf pid`

## 2ã€çº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«

* **è¿›ç¨‹é—´çš„ä¿¡æ¯éš¾ä»¥å…±äº«**ã€‚ç”±äºé™¤å»åªè¯»ä»£ç æ®µå¤–ï¼Œçˆ¶å­è¿›ç¨‹å¹¶æœªå…±äº«å†…å­˜ï¼Œå› æ­¤å¿…é¡»é‡‡ç”¨ä¸€äº›è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ï¼Œåœ¨è¿›ç¨‹é—´è¿›è¡Œä¿¡æ¯äº¤æ¢ã€‚ 
* è°ƒç”¨ fork() æ¥åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·ç›¸å¯¹è¾ƒé«˜ï¼Œå³ä¾¿åˆ©ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œä»ç„¶éœ€è¦å¤åˆ¶è¯¸å¦‚ å†…å­˜é¡µè¡¨å’Œæ–‡ä»¶æè¿°ç¬¦è¡¨ä¹‹ç±»çš„å¤šç§è¿›ç¨‹å±æ€§ï¼Œè¿™æ„å‘³ç€ fork() è°ƒç”¨åœ¨æ—¶é—´ä¸Šçš„å¼€é”€ä¾ç„¶ä¸è²ã€‚ 
* çº¿ç¨‹ä¹‹é—´èƒ½å¤Ÿæ–¹ä¾¿ã€å¿«é€Ÿåœ°å…±äº«ä¿¡æ¯ã€‚åªéœ€å°†æ•°æ®å¤åˆ¶åˆ°å…±äº«ï¼ˆå…¨å±€æˆ–å †ï¼‰å˜é‡ä¸­å³å¯ã€‚ 
* åˆ›å»ºçº¿ç¨‹æ¯”åˆ›å»ºè¿›ç¨‹é€šå¸¸è¦å¿« 10 å€ç”šè‡³æ›´å¤šã€‚**çº¿ç¨‹é—´æ˜¯å…±äº«è™šæ‹Ÿåœ°å€ç©ºé—´çš„ï¼Œæ— éœ€é‡‡ç”¨å†™æ—¶å¤åˆ¶æ¥å¤åˆ¶å†…å­˜ï¼Œä¹Ÿæ— éœ€å¤åˆ¶é¡µè¡¨ã€‚**



## 3ã€çº¿ç¨‹å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´

![çº¿ç¨‹ä¸è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/çº¿ç¨‹ä¸è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´.2ci5rxqr4bdw.webp)

* çº¿ç¨‹æ˜¯å…±äº«è™šæ‹Ÿåœ°å€ç©ºé—´çš„ï¼Œåªä¸è¿‡çº¿ç¨‹åœ¨æ ˆç©ºé—´ï¼Œå’Œä»£ç æ®µï¼ˆ.textï¼‰éƒ½æœ‰è‡ªå·±çš„ä¸€å—åŒºåŸŸï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œè‡ªå·±çš„é‚£å—åŒºåŸŸçš„ä»£ç 

* mainçº¿ç¨‹è¢«ç§°ä¸ºä¸»çº¿ç¨‹



## 4ã€çº¿ç¨‹ä¹‹é—´å…±äº«å’Œéå…±äº«èµ„æº

### 4.1 å…±äº«èµ„æº

* è¿›ç¨‹ ID å’Œçˆ¶è¿›ç¨‹ ID
* è¿›ç¨‹ç»„ ID å’Œä¼šè¯ ID
* ç”¨æˆ· ID å’Œ ç”¨æˆ·ç»„ ID
* æ–‡ä»¶æè¿°ç¬¦è¡¨
* ä¿¡å·å¤„ç½® ï¼ˆæ³¨å†Œçš„ä¿¡å·å¤„ç†ï¼‰
* æ–‡ä»¶ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯ï¼šæ–‡ä»¶æƒé™æ©ç ï¼ˆumaskï¼‰ã€å½“å‰å·¥ä½œç›®å½•
* è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆé™¤æ ˆã€.textï¼‰

> ä»”ç»†ä¸€çœ‹ä¸Šé¢å¤„ç†æœ€åä¸€æ¡ï¼Œéƒ½æ˜¯å†…æ ¸é‡Œçš„

### 4.2 éå…±äº«èµ„æº

* çº¿ç¨‹ ID
* ä¿¡å·æ©ç  ï¼ˆé˜»å¡ä¿¡å·é›†ï¼‰
* çº¿ç¨‹ç‰¹æœ‰æ•°æ®
* error å˜é‡
* å®æ—¶è°ƒåº¦ç­–ç•¥å’Œä¼˜å…ˆçº§
* æ ˆï¼Œæœ¬åœ°å˜é‡å’Œå‡½æ•°çš„è°ƒç”¨é“¾æ¥ä¿¡



## 5ã€NPTL

* å½“ Linux æœ€åˆå¼€å‘æ—¶ï¼Œåœ¨å†…æ ¸ä¸­å¹¶ä¸èƒ½çœŸæ­£æ”¯æŒçº¿ç¨‹ã€‚ä½†æ˜¯å®ƒçš„ç¡®å¯ä»¥é€šè¿‡ clone()  ç³»ç»Ÿè°ƒç”¨å°†è¿›ç¨‹ä½œä¸ºå¯è°ƒåº¦çš„å®ä½“ã€‚è¿™ä¸ªè°ƒç”¨åˆ›å»ºäº†è°ƒç”¨è¿›ç¨‹ï¼ˆcalling processï¼‰çš„ ä¸€ä¸ªæ‹·è´ï¼Œè¿™ä¸ªæ‹·è´ä¸è°ƒç”¨è¿›ç¨‹å…±äº«ç›¸åŒçš„åœ°å€ç©ºé—´ã€‚LinuxThreads é¡¹ç›®ä½¿ç”¨è¿™ä¸ªè°ƒç”¨æ¥å®Œæˆåœ¨ç”¨æˆ·ç©ºé—´æ¨¡æ‹Ÿå¯¹çº¿ç¨‹çš„æ”¯æŒã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•æœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå°¤å…¶æ˜¯åœ¨ä¿¡å·å¤„ç†ã€è°ƒåº¦å’Œè¿›ç¨‹é—´åŒæ­¥ç­‰æ–¹é¢éƒ½å­˜åœ¨é—®é¢˜ã€‚å¦å¤–ï¼Œè¿™ä¸ªçº¿ç¨‹æ¨¡å‹ä¹Ÿä¸ç¬¦åˆ POSIX çš„è¦æ±‚ã€‚ 
* è¦æ”¹è¿› LinuxThreadsï¼Œéœ€è¦å†…æ ¸çš„æ”¯æŒï¼Œå¹¶ä¸”é‡å†™çº¿ç¨‹åº“ã€‚æœ‰ä¸¤ä¸ªç›¸äº’ç«äº‰çš„é¡¹ç›®å¼€å§‹ æ¥æ»¡è¶³è¿™äº›è¦æ±‚ã€‚ä¸€ä¸ªåŒ…æ‹¬ IBM çš„å¼€å‘äººå‘˜çš„å›¢é˜Ÿå¼€å±•äº† NGPTï¼ˆNext-Generation  POSIX Threadsï¼‰é¡¹ç›®ã€‚åŒæ—¶ï¼ŒRed Hat çš„ä¸€äº›å¼€å‘äººå‘˜å¼€å±•äº† NPTL é¡¹ç›®ã€‚NGPT  åœ¨ 2003 å¹´ä¸­æœŸè¢«æ”¾å¼ƒäº†ï¼ŒæŠŠè¿™ä¸ªé¢†åŸŸå®Œå…¨ç•™ç»™äº† NPTLã€‚ 
* NPTLï¼Œæˆ–ç§°ä¸º Native POSIX Thread Libraryï¼Œæ˜¯ Linux çº¿ç¨‹çš„ä¸€ä¸ªæ–°å®ç°ï¼Œå®ƒ å…‹æœäº† LinuxThreads çš„ç¼ºç‚¹ï¼ŒåŒæ—¶ä¹Ÿç¬¦åˆ POSIX çš„éœ€æ±‚ã€‚ä¸ LinuxThreads ç›¸ æ¯”ï¼Œå®ƒåœ¨æ€§èƒ½å’Œç¨³å®šæ€§æ–¹é¢éƒ½æä¾›äº†é‡å¤§çš„æ”¹è¿›ã€‚ 
* **æŸ¥çœ‹å½“å‰ pthread åº“ç‰ˆæœ¬**ï¼š`getconf GNU_LIBPTHREAD_VERSION`



## 6ã€çº¿ç¨‹æ“ä½œ

> * int pthread_create(pthread_t *thread, const pthread_attr_t *attr,  void *(*start_routine) (void *), void *arg); 
> * pthread_t pthread_self(void); 
> * int pthread_equal(pthread_t t1, pthread_t t2); 
> * void pthread_exit(void *retval); 
> * int pthread_join(pthread_t thread, void **retval); 
> * int pthread_detach(pthread_t thread); 
> * int pthread_cancel(pthread_t thread);

### 6.1 åˆ›å»ºçº¿ç¨‹

#### 6.1.1 pthread_createå‡½æ•°

```c
//ä¸€èˆ¬æƒ…å†µä¸‹,mainå‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹æˆ‘ä»¬ç§°ä¹‹ä¸ºä¸»çº¿ç¨‹ï¼ˆmainçº¿ç¨‹ï¼‰ï¼Œå…¶ä½™åˆ›å»ºçš„çº¿ç¨‹ç§°ä¹‹ä¸ºå­çº¿ç¨‹ã€‚
//ç¨‹åºä¸­é»˜è®¤åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œfork()å‡½æ•°è°ƒç”¨ï¼Œ2ä¸ªè¿›ç¨‹ï¼ˆçˆ¶ä¸å­ï¼‰
//ç¨‹åºä¸­é»˜è®¤åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œpthread_create()å‡½æ•°è°ƒç”¨ï¼Œäº§ç”Ÿ2ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹å’Œçº¿ç¨‹ï¼‰ã€‚
#include <pthread.h>
int pthread_create(pthread_t *thread, const pthread_attr_t *attr,
void *(*start_routine) (void *), void *arg);
    - åŠŸèƒ½ï¼šåˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
    - å‚æ•°ï¼š
        - threadï¼šä¼ å‡ºå‚æ•°ï¼Œçº¿ç¨‹åˆ›å»ºæˆåŠŸåï¼Œå­çº¿ç¨‹çš„çº¿ç¨‹IDè¢«å†™åˆ°è¯¥å˜é‡ä¸­ã€‚
        - attr : è®¾ç½®çº¿ç¨‹çš„å±æ€§ï¼Œä¸€èˆ¬ä½¿ç”¨é»˜è®¤å€¼ï¼ŒNULL
        - start_routine : å‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å­çº¿ç¨‹éœ€è¦å¤„ç†çš„é€»è¾‘ä»£ç 
        - arg : ç»™ç¬¬ä¸‰ä¸ªå‚æ•°ä½¿ç”¨ï¼Œä¼ å‚
    - è¿”å›å€¼ï¼š
        æˆåŠŸï¼š0
        å¤±è´¥ï¼šè¿”å›é”™è¯¯å·ã€‚è¿™ä¸ªé”™è¯¯å·å’Œä¹‹å‰errnoä¸å¤ªä¸€æ ·ã€‚
        è·å–é”™è¯¯å·çš„ä¿¡æ¯ï¼š  char * strerror(int errnum);
```

#### 6.1.2 ä»£ç 

```c
//pthread_create.c
#include <stdio.h>
#include <pthread.h>
#include <string.h>  //strerror()
#include <unistd.h>

void *callback(void *arg)
{
    printf("child thread...\n");
    // å› ä¸º arg æ˜¯ç©ºæŒ‡é’ˆï¼Œæ‰€ä»¥å…ˆç»™å¼ºè½¬ä¸ºintå‹æŒ‡é’ˆï¼Œå†è§£å¼•ç”¨
    printf("arg value: %d\n", *(int *)arg);
    return NULL;
}

int main()
{

    pthread_t tid;

    int num = 10;

    // åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
    // å› ä¸ºæˆ‘ä»¬è¦ä¼ å…¥çš„æ˜¯ç©ºæŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠnumå¼ºè½¬ä¸º ï¼ˆvoid*ï¼‰
    int ret = pthread_create(&tid, NULL, callback, (void *)&num);
    //åˆ›å»ºå¤±è´¥
    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error : %s\n", errstr);
    }

    for (int i = 0; i < 5; i++)
    {
        printf("%d\n", i);
    }
    // sleep(1);
    return 0; // exit(0);
}
```

![åˆ›å»ºçº¿ç¨‹](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/åˆ›å»ºçº¿ç¨‹.5wq91ujv7n40.webp)

* æ³¨æ„ï¼šæˆ‘ä»¬**åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰æ–¹çš„åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶è¦æŒ‡å®šä½¿ç”¨çš„åº“**
  * ä¸Šé¢ä¸¤ç§å†™æ³•éƒ½å¯ä»¥ï¼Œåœ¨æœ«å°¾åŠ  `-lpthread` æˆ– `-pthread`
* å¦å¤–æˆ‘ä»¬è¿™é‡Œå‘ç°ï¼Œæˆ‘ä»¬åªè¾“å‡ºäº†ä¸»çº¿ç¨‹ä»£ç åº”è¯¥è¾“å‡ºçš„ï¼Œå­çº¿ç¨‹çš„è¾“å‡ºå¹¶æ²¡æœ‰æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¸»çº¿ç¨‹æ‰§è¡Œåç›´æ¥å°±é€€å‡ºäº†ï¼ŒåŒæ—¶æŠŠè™šæ‹Ÿåœ°å€ç©ºé—´éƒ½é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯çº¿ç¨‹æ˜¯å…±äº«è™šæ‹Ÿåœ°å€ç©ºé—´çš„ï¼Œæ‰€ä»¥å­çº¿ç¨‹å°±æ²¡æœ‰æ‰§è¡Œã€‚
  * è§£å†³æ–¹æ³•ï¼šä¸»çº¿ç¨‹æ‰§è¡Œå®Œåä¼‘çœ ï¼Œè®©å­çº¿ç¨‹æœ‰æ—¶é—´æ‰§è¡Œï¼ˆä¸Šé¢ä»£ç sleep(1)å–æ¶ˆæ³¨é‡Šï¼‰

### 6.2 ç»ˆæ­¢çº¿ç¨‹

#### 6.2.1 ç»ˆæ­¢çº¿ç¨‹

```c
#include <pthread.h>
void pthread_exit(void *retval);
    åŠŸèƒ½ï¼šç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨å“ªä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ï¼Œå°±è¡¨ç¤ºç»ˆæ­¢å“ªä¸ªçº¿ç¨‹
    å‚æ•°ï¼š
        retvalï¼šéœ€è¦ä¼ é€’ä¸€ä¸ªæŒ‡é’ˆï¼Œä½œä¸ºä¸€ä¸ªè¿”å›å€¼ï¼Œå¯ä»¥åœ¨pthread_joinä¸­
```

#### 6.2.2 è·å–çº¿ç¨‹id

```c
pthread_t pthread_self(void);
    åŠŸèƒ½ï¼šè·å–å½“å‰çš„çº¿ç¨‹çš„çº¿ç¨‹ID
```

#### 6.2.3 æ¯”è¾ƒçº¿ç¨‹çš„idæ˜¯å¦ç›¸ç­‰

```c
int pthread_equal(pthread_t t1,pthread_t t2);
    åŠŸèƒ½ï¼šæ¯”è¾ƒä¸¤ä¸ªçº¿ç¨‹IDæ˜¯å¦ç›¸ç­‰
    è¿”å›å€¼ï¼š å¦‚æœä¸¤ä¸ªçº¿ç¨‹ ID t1 å’Œ t2 ç›¸ç­‰ï¼Œåˆ™è¿”å›ä¸€ä¸ªéé›¶å€¼ï¼›å¦åˆ™è¿”å› 0
    //ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œpthread_tç±»å‹çš„å®ç°ä¸ä¸€æ ·ï¼Œæœ‰çš„æ˜¯æ— ç¬¦å·çš„é•¿æ•´å½¢ï¼Œæœ‰çš„æ˜¯ä½¿ç”¨ç»“æ„ä½“å»å®ç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨pthread_equalæ¥åˆ¤æ–­å…¼å®¹æ€§æ›´å¼ºã€‚
```

#### 6.2.4 ä»£ç 

```c
//pthread_exit.c
#include <pthread.h>
#include <stdio.h>
#include <string.h> //strerror

void *callback(void *arg)
{
    printf("child thread id : %ld\n", pthread_self());
    // åœ¨å­çº¿ç¨‹ä¸­return NULLå…¶å®å°±ç›¸å½“äº pthread_exit(NULL);
    return NULL;
}

int main()
{

    // åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
    pthread_t tid;
    int ret = pthread_create(&tid, NULL, callback, NULL);

    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error : %s\n", errstr);
    }

    // ä¸»çº¿ç¨‹
    for (int i = 0; i < 5; i++)
    {
        printf("%d\n", i);
    }

    printf("tid : %ld, main thread id : %ld\n", tid, pthread_self());

    // è®©ä¸»çº¿ç¨‹é€€å‡ºï¼Œå½“ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œä¸ä¼šå½±å“å…¶ä»–æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹
    pthread_exit(NULL);

    printf("main thread exit\n");
    return 0; // exit(0)
}
```

![pthread_exit](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/pthread_exit.799ea5880200.webp)

* ä½¿ç”¨pthread çº¿ç¨‹çš„å‡½æ•°ï¼Œ**åœ¨ç¼–è¯‘æ—¶è¦æŒ‡å®šå¼•ç”¨çš„åº“**  `-pthread`
* ğŸŸ¥ï¼šå¯ä»¥çœ‹å‡ºï¼Œpthread_create çš„è¿”å›å€¼ä¸ºå­çº¿ç¨‹çš„id
* ğŸƒï¼šæ²¡æœ‰æ‰“å° `main thread exit`ï¼Œå£°æ˜ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œåˆ° `pthread_exit(NULL)` ï¼Œåé¢çš„è¯­å¥å°±æ²¡æœ‰æ‰§è¡Œäº†ï¼Œï¼ˆæ²¡æœ‰æ‰§è¡Œ`return 0`ä¹Ÿå°±æ²¡æœ‰é‡Šæ”¾è™šæ‹Ÿåœ°å€ç©ºé—´ï¼‰

* ï¼ˆè¿™é‡Œçœ‹ä¸å‡ºæ¥ï¼‰ï¼Œå’Œçˆ¶å­è¿›ç¨‹æ˜¯äº¤æ›¿æ‰§è¡Œçš„ä¸€æ ·ï¼Œ**å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹Ÿæ˜¯äº¤æ›¿æ‰§è¡Œçš„**



### 6.3 å›æ”¶å­çº¿ç¨‹

#### 6.3.1 pthread_join

```c
#include <pthread.h>
int pthread_join(pthread_t thread, void **retval);
    - åŠŸèƒ½ï¼šå’Œä¸€ä¸ªå·²ç»ç»ˆæ­¢çš„çº¿ç¨‹è¿›è¡Œè¿æ¥
            å›æ”¶å­çº¿ç¨‹çš„èµ„æº
            è¿™ä¸ªå‡½æ•°æ˜¯â—â—é˜»å¡å‡½æ•°â—â—ï¼Œè°ƒç”¨ä¸€æ¬¡åªèƒ½å›æ”¶ä¸€ä¸ªå­çº¿ç¨‹
            ä¸€èˆ¬åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨
    - å‚æ•°ï¼š
        - threadï¼šéœ€è¦å›æ”¶çš„å­çº¿ç¨‹çš„ID
        - retval: æ¥æ”¶å­çº¿ç¨‹é€€å‡ºæ—¶çš„è¿”å›å€¼
    - è¿”å›å€¼ï¼š
        0 : æˆåŠŸ
        é0 : å¤±è´¥ï¼Œè¿”å›çš„é”™è¯¯å·
```

#### 6.3.2 ä»£ç 

```c
//pthread_join.c
#include <pthread.h>
#include <stdio.h>
#include <string.h> //strerror
#include <unistd.h> //sleep

void *callback(void *arg)
{
    printf("child thread id : %ld\n", pthread_self());
    sleep(3);
    // return NULL;
    int value = 10;
    // å› ä¸ºpthread_exit(void *retval)å‡ºå…¥çš„æ˜¯voidå‹æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è¿›è¡Œå¼ºè½¬
    pthread_exit((void *)&value); // return (void)*&value; ç›¸ç­‰
}

int main()
{

    // åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
    pthread_t tid;
    int ret = pthread_create(&tid, NULL, callback, NULL);

    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error : %s\n", errstr);
    }

    // ä¸»çº¿ç¨‹
    for (int i = 0; i < 5; i++)
    {
        printf("%d\n", i);
    }

    printf("tid : %ld, main thread id : %ld\n", tid, pthread_self());

    // ä¸»çº¿ç¨‹è°ƒç”¨ pthread_join() å›æ”¶å­çº¿ç¨‹çš„èµ„æº
    int *thread_retval;
    // ç¬¬äºŒä¸ªå‚æ•°åº”è¯¥æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ªæŒ‡é’ˆï¼Œç„¶åä¼ å…¥è¯¥æŒ‡é’ˆçš„åœ°å€
    ret = pthread_join(tid, (void **)&thread_retval);
    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error : %s\n", errstr);
    }

    printf("exit data : %d\n", *thread_retval);

    printf("å›æ”¶å­çº¿ç¨‹èµ„æºæˆåŠŸï¼\n");

    // è®©ä¸»çº¿ç¨‹é€€å‡ºï¼Œå½“ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œä¸ä¼šå½±å“å…¶ä»–æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹
    pthread_exit(NULL);

    return 0;
}
```

![pthread_join(1)](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/pthread_join(1).2zrsko8ffk40.webp)

* æ‰§è¡Œåï¼Œå‘ç°æˆ‘ä»¬æ‰“å°å‡ºæ¥çš„å­çº¿ç¨‹é€€å‡ºæ—¶çš„è¿”å›å€¼å¹¶ä¸æ˜¯ 10ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¸Šé¢ä»£ç é‡Œçš„ å­è¿›ç¨‹æ‰§è¡Œç»“æŸåè¿”å›çš„ valueæ˜¯**å±€éƒ¨å˜é‡**ï¼Œï¼ˆæ˜¯å­˜æ”¾åœ¨å­çº¿ç¨‹å¯¹åº”æ ˆç©ºé—´é‡Œçš„ï¼‰åœ¨å­çº¿ç¨‹æ‰§è¡Œç»“æŸåï¼Œå­çº¿ç¨‹çš„è¿™å—æ ˆç©ºé—´è¢«é‡Šæ”¾æ‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰“å°å‡ºæ¥çš„å€¼ä¸æ˜¯ 10ã€‚

* æ‰€ä»¥è¯´ï¼Œ**å­çº¿ç¨‹è¦è¿”å›å€¼çš„è¯ï¼Œä¸è¦è¿”å›å±€éƒ¨å˜é‡**ï¼Œè¦è¿”å›å…¨å±€å˜é‡ã€‚

* ğŸŸ¥å’Œä¸‹é¢æ‰“å°çš„è¯­å¥æ˜¯åœ¨3såè¾“å‡ºçš„ï¼Œè¯æ˜äº†pthread_joinæ˜¯é˜»å¡çš„ï¼Œéœ€è¦ç­‰å›æ”¶å®Œå­çº¿ç¨‹çš„èµ„æºæ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œ



#### 6.3.3 æ€è€ƒ

* ä¸ºä»€ä¹ˆ`int pthread_join(pthread_t thread, void **retval)`ç¬¬äºŒä¸ªå‚æ•°è¦ä¼ å…¥çš„æ˜¯äºŒçº§æŒ‡é’ˆï¼Ÿ
* ç­”ï¼šï¼ˆä»¥ä¸Šé¢ä»£ç ä¸ºä¾‹ï¼‰
  * å‡½æ•°callbackè¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè¦æƒ³æ¥æ”¶è¿™ä¸ªè¿”å›å€¼éœ€è¦ä¸€ä¸ªæŒ‡é’ˆç±»å‹ã€‚æ‰€ä»¥å®šä¹‰äº† int *thread_retvalå»æ¥æ”¶è¿”å›çš„æŒ‡é’ˆã€‚
  * è€Œpthread_join() å‡½æ•°åœ¨å®Œæˆå­çº¿ç¨‹èµ„æºå›æ”¶çš„åŒæ—¶**è¦æŠŠå­çº¿ç¨‹è¿”å›å€¼èµ‹ç»™ç¬¬äºŒä¸ªå‚æ•°**ï¼ˆä¿®æ”¹äº†thread_retvalçš„å€¼ï¼‰ï¼Œç”¨äºŒçº§æŒ‡é’ˆæ˜¯ä¸ºäº†ä¿®æ”¹ä¸»çº¿ç¨‹ä¸­å®šä¹‰çš„ä¸€çº§æŒ‡é’ˆ thread_retvalï¼Œä¸ç„¶ä¿®æ”¹çš„åªæ˜¯ä¼ å…¥çš„å‰¯æœ¬ã€‚

### 6.4 çº¿ç¨‹åˆ†ç¦»

#### 6.4.1 pthread_detach

```c
#include <pthread.h>
int pthread_detach(pthread_t thread);
    - åŠŸèƒ½ï¼šåˆ†ç¦»ä¸€ä¸ªçº¿ç¨‹ã€‚è¢«åˆ†ç¦»çš„çº¿ç¨‹åœ¨ç»ˆæ­¢çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾èµ„æºè¿”å›ç»™ç³»ç»Ÿã€‚
      1.ä¸èƒ½å¤šæ¬¡åˆ†ç¦»ï¼Œä¼šäº§ç”Ÿä¸å¯é¢„æ–™çš„è¡Œä¸ºã€‚
      2.ä¸èƒ½å»è¿æ¥(join)ä¸€ä¸ªå·²ç»åˆ†ç¦»çš„çº¿ç¨‹ï¼Œä¼šæŠ¥é”™ã€‚
    - å‚æ•°ï¼šéœ€è¦åˆ†ç¦»çš„çº¿ç¨‹çš„ID
    - è¿”å›å€¼ï¼š
        æˆåŠŸï¼š0
        å¤±è´¥ï¼šè¿”å›é”™è¯¯å·
```

#### 6.4.2 ä»£ç æµ‹è¯•

```c
//pthread_detach.c

#include <pthread.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

void *callback(void *arg)
{
    printf("child thread id : %ld\n", pthread_self());
    return 0;
}

int main()
{

    // åˆ›å»ºçº¿ç¨‹
    pthread_t tid;
    int ret = pthread_create(&tid, NULL, callback, NULL);

    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error1 : %s\n", errstr);
    }

    // è¾“å‡ºä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„id
    printf("tid : %ld, main thread id : %ld\n", tid, pthread_self());

    // è®¾ç½®å­çº¿ç¨‹åˆ†ç¦»,å­çº¿ç¨‹åˆ†ç¦»åï¼Œå­çº¿ç¨‹ç»“æŸæ—¶å¯¹åº”çš„èµ„æºå°±ä¸éœ€è¦ä¸»çº¿ç¨‹é‡Šæ”¾
    ret = pthread_detach(tid);
    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error2 : %s\n", errstr);
    }

    // è®¾ç½®åˆ†ç¦»åï¼Œå¯¹åˆ†ç¦»çš„å­çº¿ç¨‹è¿›è¡Œè¿æ¥ pthread_join()
    ret = pthread_join(tid, NULL);
    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error3 : %s\n", errstr);
    }

    pthread_exit(NULL);

    return 0;
}
```

![pthread_detach](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/pthread_detach.5rkg7091txk0.webp)

* ğŸŸ¥å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œçº¿ç¨‹åˆ†ç¦»åä¸èƒ½å†è°ƒç”¨ `pthread_join()`å‡½æ•°å»è¿æ¥ï¼Œå› ä¸ºçº¿ç¨‹åˆ†ç¦»åè¢«åˆ†ç¦»çš„çº¿ç¨‹åœ¨ç»ˆæ­¢çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾èµ„æºè¿”å›ç»™ç³»ç»Ÿï¼Œä¸éœ€è¦ä½¿ç”¨joinå»è¿æ¥å›æ”¶å­çº¿ç¨‹çš„èµ„æº

### 6.5 çº¿ç¨‹å–æ¶ˆ

#### 6.5.1 pthread_cancel

```c
#include <pthread.h>
int pthread_cancel(pthread_t thread);
    - åŠŸèƒ½ï¼šå–æ¶ˆçº¿ç¨‹ï¼ˆè®©çº¿ç¨‹ç»ˆæ­¢ï¼‰
        å–æ¶ˆæŸä¸ªçº¿ç¨‹ï¼Œå¯ä»¥ç»ˆæ­¢æŸä¸ªçº¿ç¨‹çš„è¿è¡Œï¼Œ
        ä½†æ˜¯å¹¶ä¸æ˜¯ç«‹é©¬ç»ˆæ­¢ï¼Œè€Œæ˜¯å½“å­çº¿ç¨‹æ‰§è¡Œåˆ°ä¸€ä¸ªå–æ¶ˆç‚¹ï¼Œçº¿ç¨‹æ‰ä¼šç»ˆæ­¢ã€‚
      å–æ¶ˆç‚¹ï¼šç³»ç»Ÿè§„å®šå¥½çš„ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ç²—ç•¥çš„ç†è§£ä¸ºä»ç”¨æˆ·åŒºåˆ°å†…æ ¸åŒºçš„åˆ‡æ¢è¿™ä¸ªä½ç½®ç§°ä¹‹ä¸ºå–æ¶ˆç‚¹ã€‚
```

#### 6.5.2 ä»£ç æµ‹è¯•

```c
//pthread_cancel.c
#include <stdio.h>
#include <pthread.h>
#include <string.h>
#include <unistd.h>

void *callback(void *arg)
{
    printf("chid thread id : %ld\n", pthread_self());
    for (int i = 0; i < 5; i++)
    {
        printf("child : %d\n", i);
    }
    return NULL;
}

int main()
{

    // åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
    pthread_t tid;
    int ret = pthread_create(&tid, NULL, callback, NULL);
    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error1 : %s\n", errstr);
    }
    // å–æ¶ˆçº¿ç¨‹
    pthread_cancel(tid);

    for (int i = 0; i < 5; i++)
    {
        printf("%d\n", i);
    }
    // è¾“å‡ºä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„id
    printf("tid : %ld, main thread id : %ld\n", tid, pthread_self());

    pthread_exit(NULL);
    return 0;
}
```

![pthread_cancel](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/pthread_cancel.3fvqvqppzta0.webp)

* **printf() ä¸æ˜¯ä¸€ä¸ªå–æ¶ˆç‚¹ï¼Œä½†æ˜¯printf ä¼šè°ƒç”¨ writeåœ¨stdouté‡Œé¢å†™æ•°æ®ï¼Œè€Œwriteæ˜¯è¦è¿›è¡Œä¸€ä¸ªç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢çš„**
* ğŸŸ§å­çº¿ç¨‹å…ˆæ‰§è¡Œå®Œäº†ï¼Œå†æ‰§è¡Œåˆ°çš„çº¿ç¨‹å–æ¶ˆï¼Œæ‰€ä»¥å…¨éƒ¨éƒ½è¾“å‡ºäº†å‡ºæ¥
* ğŸŸ¨å­çº¿ç¨‹è¿˜æ²¡æ‰§è¡Œforå¾ªç¯ï¼Œä¸»çº¿ç¨‹å°±ä¸­å†™åˆ°äº† `pthread_cancel`,åˆå› ä¸º`printf()` å°±æ˜¯å–æ¶ˆç‚¹ï¼Œæ‰€ä»¥å­çº¿ç¨‹æ²¡æœ‰è¾“å‡º 0~4

## 7ã€çº¿ç¨‹å±æ€§

### 7.1 æŸ¥çœ‹çº¿ç¨‹å±æ€§å‡½æ•°

* `man pthread_attr_`ç„¶åæŒ‰ä¸¤æ¬¡ `tableé”®`

![æŸ¥çœ‹çº¿ç¨‹å±æ€§å‡½æ•°](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/æŸ¥çœ‹çº¿ç¨‹å±æ€§.408f0wt1zm60.webp)

### 7.2 å¸¸ç”¨å‡½æ•°

> * çº¿ç¨‹å±æ€§ç±»å‹ pthread_attr_t  

```c
int pthread_attr_init(pthread_attr_t *attr);
    - åˆå§‹åŒ–çº¿ç¨‹å±æ€§å˜é‡
int pthread_attr_destroy(pthread_attr_t *attr);
    - é‡Šæ”¾çº¿ç¨‹å±æ€§çš„èµ„æº
        
int pthread_attr_getdetachstate(const pthread_attr_t *attr, int *detachstate);
    - è·å–çº¿ç¨‹åˆ†ç¦»çš„çŠ¶æ€å±æ€§

int pthread_attr_setdetachstate(pthread_attr_t *attr, int detachstate);
     - è®¾ç½®çº¿ç¨‹åˆ†ç¦»çš„çŠ¶æ€å±æ€§
     - å‚æ•°ï¼š
         - detachstateï¼š
             PTHREAD_CREATE_DETACHED ä½¿ç”¨ attr åˆ›å»ºçš„çº¿ç¨‹å°†æ˜¯ç‹¬ç«‹çš„ï¼Œè®¾ç½®çº¿ç¨‹åˆ†ç¦»çš„æ„æ€ã€‚
             PTHREAD_CREATE_JOINABLEï¼ˆé»˜è®¤æ˜¯è¿™ä¸ªï¼‰ ä½¿ç”¨ attr åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¯ä»¥è¢«joinçš„ã€‚
```

### 7.3 ä»£ç 

```c
//pthread_attr.c

#include <stdio.h>
#include <pthread.h>
#include <string.h>
#include <unistd.h>

void *callback(void *arg)
{
    printf("chid thread id : %ld\n", pthread_self());
    return NULL;
}

int main()
{

    // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å±æ€§å˜é‡
    pthread_attr_t attr;
    // åˆå§‹åŒ–å±æ€§å˜é‡
    pthread_attr_init(&attr);
    // è®¾ç½®å±æ€§
    pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);

    // åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹
    pthread_t tid;
    int ret = pthread_create(&tid, &attr, callback, NULL);
    if (ret != 0)
    {
        char *errstr = strerror(ret);
        printf("error1 : %s\n", errstr);
    }

    // è·å–çº¿ç¨‹çš„æ ˆçš„å¤§å°
    size_t size;
    pthread_attr_getstacksize(&attr, &size);
    printf("thread stack size : %ld\n", size);

    // è¾“å‡ºä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„id
    printf("tid : %ld, main thread id : %ld\n", tid, pthread_self());

    // é‡Šæ”¾çº¿ç¨‹å±æ€§èµ„æº
    pthread_attr_destroy(&attr);
    pthread_exit(NULL);
    return 0;
}

```

![pthread_attr](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/pthread_attr.3voa04j43tq0.webp)

* ä¸€èˆ¬ç³»ç»Ÿé»˜è®¤ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…**8MB**çš„æ ˆç©ºé—´
  * å³ `8 MB = 8388608 B`
* ä¸€èˆ¬ä¸éœ€è¦è‡ªå·±æ¥ç®¡ç†çº¿ç¨‹å †æ ˆï¼ŒLinuxé»˜è®¤ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†è¶³å¤Ÿçš„å †æ ˆç©ºé—´ï¼ˆä¸€èˆ¬æ˜¯8MBï¼‰ï¼Œå¯ä»¥ç”¨ulimit -s å‘½ä»¤æŸ¥çœ‹æˆ–ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ï¼›