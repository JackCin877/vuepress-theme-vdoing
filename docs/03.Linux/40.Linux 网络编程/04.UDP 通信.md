---
title: UDP é€šä¿¡
date: 2023-09-12 17:03:37
permalink: /pages/8f29ae/
categories:
  - Linux
  - Linux ç½‘ç»œç¼–ç¨‹
tags:
  - 
author: 
  name: JackCin
  link: https://github.com/JackCin877
---
# UDP

## 1ã€UDP é€šä¿¡

![UDP-é€šä¿¡](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/UDP-é€šä¿¡.7havpnvf6pk0.webp)

### 1.1 å‡½æ•°ä»‹ç»

```c
#include <sys/types.h>
#include <sys/socket.h>
ssize_t sendto(int sockfd, const void *buf, size_t len, int flags,
const struct sockaddr *dest_addr, socklen_t addrlen);
	- å‚æ•°ï¼š
		- sockfd : é€šä¿¡çš„fd
		- buf : è¦å‘é€çš„æ•°æ®
		- len : å‘é€æ•°æ®çš„é•¿åº¦
		- flags : 0
		- dest_addr : é€šä¿¡çš„å¦å¤–ä¸€ç«¯çš„åœ°å€ä¿¡æ¯
		- addrlen : åœ°å€çš„å†…å­˜å¤§å°
     - è¿”å›å€¼ï¼šæˆåŠŸè¿”å›å‘é€çš„å­—èŠ‚çš„æ•°é‡ï¼Œå¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½®åˆ°erron
ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags,
struct sockaddr *src_addr, socklen_t *addrlen);
	- å‚æ•°ï¼š
		- sockfd : é€šä¿¡çš„fd
		- buf : æ¥æ”¶æ•°æ®çš„æ•°ç»„
		- len : æ•°ç»„çš„å¤§å°
        - flags : 0ï¼ˆè®¾ç½®ä¸€äº›æ ‡å¿—ï¼Œä¸€èˆ¬ä¸ä¼šç”¨ï¼‰
		- src_addr : ç”¨æ¥ä¿å­˜å¦å¤–ä¸€ç«¯çš„åœ°å€ä¿¡æ¯ï¼Œä¸éœ€è¦å¯ä»¥æŒ‡å®šä¸ºNULL
		- addrlen : åœ°å€çš„å†…å­˜å¤§å°
    - è¿”å›å€¼ï¼šæˆåŠŸè¿”å›æ¥æ”¶çš„å­—èŠ‚çš„æ•°é‡ï¼Œå¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½®åˆ°erron
```



### 1.2 ä»£ç æ¡ˆä¾‹

```c
// udp_server.c

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <arpa/inet.h>

int main()
{

    // 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
    int fd = socket(PF_INET, SOCK_DGRAM, 0);

    if (fd == -1)
    {
        perror("socket");
        exit(-1);
    }

    struct sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(9999);
    addr.sin_addr.s_addr = INADDR_ANY;

    // 2.ç»‘å®š
    int ret = bind(fd, (struct sockaddr *)&addr, sizeof(addr));
    if (ret == -1)
    {
        perror("bind");
        exit(-1);
    }

    // 3.é€šä¿¡
    while (1)
    {
        char recvbuf[128];
        char ipbuf[16];

        // ç”¨æ¥åœ¨recvfromå‡½æ•°è°ƒç”¨æ—¶ ä¿å­˜å¦ä¸€ç«¯çš„ä¿¡æ¯
        struct sockaddr_in cliaddr;
        int len = sizeof(cliaddr);

        // æ¥æ”¶æ•°æ®
        int num = recvfrom(fd, recvbuf, sizeof(recvbuf), 0, (struct sockaddr *)&cliaddr, &len);

        // inet_ntop çš„è¿”å›å€¼å°±æ˜¯ ipbuf
        // ntohs å°†cliaddr.sin_port è½¬åŒ–ä¸º ä¸»æœºå­—èŠ‚åº
        printf("client IP : %s, Port : %d\n",
               inet_ntop(AF_INET, &cliaddr.sin_addr.s_addr, ipbuf, sizeof(ipbuf)),
               ntohs(cliaddr.sin_port));

        printf("client say : %s\n", recvbuf);

        // å‘é€æ•°æ®
        sendto(fd, recvbuf, strlen(recvbuf) + 1, 0, (struct sockaddr *)&cliaddr, sizeof(cliaddr));
    }

    close(fd);
    return 0;
}
```

```c
// udp_client.c

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <arpa/inet.h>

int main()
{

    // 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
    int fd = socket(PF_INET, SOCK_DGRAM, 0);

    if (fd == -1)
    {
        perror("socket");
        exit(-1);
    }

    // æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯
    struct sockaddr_in saddr;
    saddr.sin_family = AF_INET;
    saddr.sin_port = htons(9999);
    inet_pton(AF_INET, "127.0.0.1", &saddr.sin_addr.s_addr);

    int num = 0;
    // 3.é€šä¿¡
    while (1)
    {

        // å‘é€æ•°æ®
        char sendBuf[128];
        sprintf(sendBuf, "hello , i am client %d \n", num++);
        sendto(fd, sendBuf, strlen(sendBuf) + 1, 0, (struct sockaddr *)&saddr, sizeof(saddr));

        // æ¥æ”¶æ•°æ® (recvfrom çš„ç¬¬5ä¸ªå‚æ•°æ˜¯ç”¨æ¥ä¿å­˜å¦ä¸€ç«¯çš„ä¿¡æ¯çš„)
        // å› ä¸ºæœåŠ¡ç«¯å‘è¿‡æ¥çš„æ•°æ®å°±æ˜¯åœ¨ fdçš„è¯»ç¼“å†²åŒºé‡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥æ”¶æ—¶ä¸ç”¨å†™å¦å¤–ä¸€ç«¯çš„åœ°å€ä¿¡æ¯
        // åŒæ ·ä¹Ÿå°±ä¸ç”¨å†™åœ°å€çš„å†…å­˜å¤§å°
        // å½“ç„¶ï¼Œå°±ç®—æˆ‘ä»¬æŒ‰ä¸‹é¢ä¸€è¡Œè¿™æ ·æŒ‡å®šæœåŠ¡ç«¯åœ°å€ä¹Ÿå¯ä»¥çš„
        // int num = recvfrom(fd, sendBuf, sizeof(sendBuf), 0, (struct sockaddr *)&saddr, sizeof(saddr));
        int num = recvfrom(fd, sendBuf, sizeof(sendBuf), 0, NULL, NULL);
        printf("server say : %s\n", sendBuf);

        sleep(1);
    }

    close(fd);
    return 0;
}
```



![UDPé€šä¿¡](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/UDPé€šä¿¡.6pcku40zbm00.webp)





## 2ã€å¹¿æ’­

> * å‘å­ç½‘ä¸­å¤šå°è®¡ç®—æœºå‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”å­ç½‘ä¸­æ‰€æœ‰çš„è®¡ç®—æœºéƒ½å¯ä»¥æ¥æ”¶åˆ°å‘é€æ–¹å‘é€çš„æ¶ˆæ¯ï¼Œæ¯ä¸ªå¹¿ æ’­æ¶ˆæ¯éƒ½åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„IPåœ°å€ï¼Œè¿™ä¸ªIPä¸­å­ç½‘å†…ä¸»æœºæ ‡å¿—éƒ¨åˆ†çš„äºŒè¿›åˆ¶å…¨éƒ¨ä¸º1ã€‚ 
>   * a.åªèƒ½åœ¨å±€åŸŸç½‘ä¸­ä½¿ç”¨ã€‚ 
>   * b.å®¢æˆ·ç«¯éœ€è¦ç»‘å®šæœåŠ¡å™¨å¹¿æ’­ä½¿ç”¨çš„ç«¯å£ï¼Œæ‰å¯ä»¥æ¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ã€‚

![å¹¿æ’­](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å¹¿æ’­.1aosc7qgg6a.webp)

```c
// è®¾ç½®å¹¿æ’­å±æ€§çš„å‡½æ•°ï¼ˆå’Œè®¾ç½®ç«¯å£å¤ç”¨ä¸€æ ·ï¼Œå°±æ˜¯ç”¨äº†ä¸ä¸€æ ·å¾—å‚æ•°ï¼‰
int setsockopt(int sockfd, int level, int optname,const void *optval, socklen_toptlen);
	- sockfd : æ–‡ä»¶æè¿°ç¬¦
	- level : SOL_SOCKET
	- optname : SO_BROADCAST
	- optval : intç±»å‹çš„å€¼ï¼Œä¸º1è¡¨ç¤ºå…è®¸å¹¿æ’­
	- optlen : optvalçš„å¤§å°
```

### 2.1 ä»£ç 

```c
//bro_server.c
// æœåŠ¡å™¨ç«¯æ˜¯ç”¨æ¥å‘é€æ•°æ®çš„ï¼Œæ‰€ä»¥ä¸ç”¨å»ç»‘å®šipï¼Œç«¯å£ç­‰ä¿¡æ¯
// å¹¿æ’­ï¼ˆå‘é€ç«¯ï¼‰ï¼šåˆ›å»ºé€šä¿¡çš„ socket â€”â€”> è®¾ç½®å¹¿æ’­å±æ€§ â€”â€”> åˆ›å»ºå¹¿æ’­åœ°å€ â€”â€”> é€šä¿¡

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <arpa/inet.h>

int main()
{

    // 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
    int fd = socket(PF_INET, SOCK_DGRAM, 0);
    if (fd == -1)
    {
        perror("socket");
        exit(-1);
    }

    // 2.è®¾ç½®å¹¿æ’­å±æ€§
    int op = 1;
    setsockopt(fd, SOL_SOCKET, SO_BROADCAST, &op, sizeof(op));

    // 3.åˆ›å»ºä¸€ä¸ªå¹¿æ’­çš„åœ°å€
    struct sockaddr_in cliaddr;
    cliaddr.sin_family = AF_INET;
    cliaddr.sin_port = htons(9999);
    // æ³¨æ„è¿™é‡Œç”¨çš„æ˜¯å¹¿æ’­åœ°å€
    inet_pton(AF_INET, "192.168.186.255", &cliaddr.sin_addr.s_addr);

    // 3.é€šä¿¡
    int num = 0;
    while (1)
    {

        char sendBuf[128];
        sprintf(sendBuf, "hello, client....%d\n", num++);
        // å‘é€æ•°æ®
        // å‘æˆ‘ä»¬åˆ›å»ºçš„å®¢æˆ·ç«¯å‘é€ä¿¡æ¯ï¼ˆå¹¿æ’­ï¼‰
        // å› ä¸ºæˆ‘ä»¬åœ°å€ä¸º 192.168.186.255 ï¼Œæ‰€ä»¥ä¼šå‘æ‰€æœ‰ipä¸º192.168.186.xxx çš„å®¢æˆ·ç«¯å‘é€ä¿¡æ¯
        sendto(fd, sendBuf, strlen(sendBuf) + 1, 0, (struct sockaddr *)&cliaddr, sizeof(cliaddr));
        printf("å¹¿æ’­çš„æ•°æ®ï¼š%s\n", sendBuf);
        sleep(1);
    }

    close(fd);
    return 0;
}
```

### 2.2 è¿è¡Œåˆ†æ

![å¹¿æ’­ä»£ç ](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å¹¿æ’­ä»£ç .1vmxl3yozlsw.webp)

* å¯è§**å¹¿æ’­çš„æ•°æ®æ˜¯æ¯”è¾ƒå®¹æ˜“ä¸¢å¤±çš„**
* æ ¹æ® `bro_client.c` ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒåŒä¸€ä¸ªä¸»æœºæ‰“å¼€çš„å®¢æˆ·ç«¯ï¼ŒIPå’Œç«¯å£éƒ½ç›¸åŒï¼Œæ‰€ä»¥åŒä¸ªä¸»æœºä¸èƒ½åŒæ—¶æ‰“å¼€ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼ˆå› æ­¤è¦éªŒè¯ä¸åŒå¹¿æ’­çš„æ•ˆæœï¼Œéœ€è¦å†å¼€ä¸ªè™šæ‹ŸæœºğŸ˜¥ï¼Œä¸‹é¢ç›´æ¥ç”¨è€å¸ˆçš„çœ‹çœ‹ï¼‰

![å¹¿æ’­ä»£ç è¿è¡Œ](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å¹¿æ’­ä»£ç è¿è¡Œ.13yh6hrvul4w.webp)

* å¯ä»¥çœ‹å‡ºï¼Œå¹¿æ’­æˆåŠŸ



## 3ã€ç»„æ’­ï¼ˆå¤šæ’­ï¼‰

### 3.1 ç»„æ’­ä»‹ç»

> * å•æ’­åœ°å€æ ‡è¯†å•ä¸ª IP æ¥å£ï¼Œå¹¿æ’­åœ°å€æ ‡è¯†æŸä¸ªå­ç½‘çš„æ‰€æœ‰ IP æ¥å£ï¼Œå¤šæ’­åœ°å€æ ‡è¯†ä¸€ç»„ IP æ¥å£ã€‚ å•æ’­å’Œå¹¿æ’­æ˜¯å¯»å€æ–¹æ¡ˆçš„ä¸¤ä¸ªæç«¯ï¼ˆè¦ä¹ˆå•ä¸ªè¦ä¹ˆå…¨éƒ¨ï¼‰ï¼Œå¤šæ’­åˆ™æ„åœ¨ä¸¤è€…ä¹‹é—´æä¾›ä¸€ç§æŠ˜ä¸­æ–¹æ¡ˆã€‚å¤šæ’­æ•°æ®æŠ¥åªåº”è¯¥ç”±å¯¹å®ƒæ„Ÿå…´è¶£çš„æ¥å£æ¥æ”¶ï¼Œä¹Ÿå°±æ˜¯è¯´ç”±è¿è¡Œç›¸åº”å¤šæ’­ä¼šè¯åº”ç”¨ç³»ç»Ÿçš„ä¸»æœºä¸Šçš„æ¥å£æ¥æ”¶ã€‚å¦å¤–ï¼Œå¹¿æ’­ä¸€èˆ¬å±€é™äºå±€åŸŸç½‘å†…ä½¿ç”¨ï¼Œè€Œå¤šæ’­åˆ™æ—¢å¯ä»¥ç”¨äºå±€åŸŸç½‘ï¼Œä¹Ÿå¯ä»¥è·¨å¹¿åŸŸç½‘ä½¿ç”¨ã€‚ 
> * a. ç»„æ’­æ—¢å¯ä»¥ç”¨äºå±€åŸŸç½‘ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¹¿åŸŸç½‘ 
> * b. **å®¢æˆ·ç«¯éœ€è¦åŠ å…¥å¤šæ’­ç»„ï¼Œæ‰èƒ½æ¥æ”¶åˆ°å¤šæ’­çš„æ•°æ®**

![ç»„æ’­](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ç»„æ’­.4axb9vz7iy40.webp)

### 3.2 ç»„æ’­åœ°å€

> * IP å¤šæ’­é€šä¿¡å¿…é¡»ä¾èµ–äº IP å¤šæ’­åœ°å€ï¼Œåœ¨ IPv4 ä¸­å®ƒçš„èŒƒå›´ä» `224.0.0.0` åˆ° `239.255.255.255` ï¼Œ å¹¶è¢«åˆ’åˆ†ä¸ºå±€éƒ¨é“¾æ¥å¤šæ’­åœ°å€ã€é¢„ç•™å¤šæ’­åœ°å€å’Œç®¡ç†æƒé™å¤šæ’­åœ°å€ä¸‰ç±»:

| IPåœ°å€                    | è¯´æ˜                                                         |
| ------------------------- | ------------------------------------------------------------ |
| 224.0.0.0~224.0.0.255     | å±€éƒ¨é“¾æ¥å¤šæ’­åœ°å€ï¼šæ˜¯ä¸ºè·¯ç”±åè®®å’Œå…¶å®ƒç”¨é€”ä¿ç•™çš„åœ°å€ï¼Œè·¯ç”±å™¨å¹¶ä¸è½¬å‘å±äºæ­¤èŒƒå›´çš„IPåŒ… |
| 224.0.1.0~224.0.1.255     | é¢„ç•™å¤šæ’­åœ°å€ï¼šå…¬ç”¨ç»„æ’­åœ°å€ï¼Œå¯ç”¨äºInternetï¼›ä½¿ç”¨å‰éœ€è¦ç”³è¯·   |
| 224.0.2.0~238.255.255.255 | é¢„ç•™å¤šæ’­åœ°å€ï¼šç”¨æˆ·å¯ç”¨ç»„æ’­åœ°å€(ä¸´æ—¶ç»„åœ°å€)ï¼Œå…¨ç½‘èŒƒå›´å†…æœ‰æ•ˆ   |
| 239.0.0.0~239.255.255.255 | æœ¬åœ°ç®¡ç†ç»„æ’­åœ°å€ï¼Œå¯ä¾›ç»„ç»‡å†…éƒ¨ä½¿ç”¨ï¼Œç±»ä¼¼äºç§æœ‰ IP åœ°å€ï¼Œä¸èƒ½ç”¨äº Internetï¼Œå¯é™åˆ¶å¤šæ’­èŒƒå›´ |

### 3.3 è®¾ç½®ç»„æ’­å‡½æ•°

```c
int setsockopt(int sockfd, int level, int optname,const void *optval,
socklen_t optlen);

// æœåŠ¡å™¨è®¾ç½®å¤šæ’­çš„ä¿¡æ¯ï¼Œå¤–å‡ºæ¥å£
	- level : IPPROTO_IP
	- optname : IP_MULTICAST_IF
	- optval : struct in_addr
// å®¢æˆ·ç«¯åŠ å…¥åˆ°å¤šæ’­ç»„ï¼š
	- level : IPPROTO_IP
	- optname : IP_ADD_MEMBERSHIP
	- optval : struct ip_mreq
        
struct ip_mreq
{
	/* IP multicast address of group. */
	struct in_addr imr_multiaddr; // ç»„æ’­çš„IPåœ°å€
	/* Local IP address of interface. */
	struct in_addr imr_interface; // æœ¬åœ°çš„IPåœ°å€
};

struct in_addr
{
	in_addr_t s_addr;
};
typedef uint32_t in_addr_t;
```

### 3.4 ä»£ç æ¡ˆä¾‹

```c
//multi_server.c

/*
    åˆ›å»ºsocket --> è®¾ç½®å¤šæ’­å±æ€§ï¼ˆå¤–æ¥å‡ºå£ï¼‰ -->
    åˆå§‹åŒ–å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯(æ³¨æ„å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯éœ€è¦æ”¹ä¸ºå¤šæ’­åœ°å€) --> é€šä¿¡
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <arpa/inet.h>

int main()
{

    // 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
    int fd = socket(PF_INET, SOCK_DGRAM, 0);
    if (fd == -1)
    {
        perror("socket");
        exit(-1);
    }

    // 2.è®¾ç½®å¤šæ’­çš„å±æ€§ï¼Œè®¾ç½®å¤–å‡ºæ¥å£
    struct in_addr imr_multiaddr;
    // åˆå§‹åŒ–å¤šæ’­åœ°å€
    inet_pton(AF_INET, "239.0.0.10", &imr_multiaddr.s_addr);
    setsockopt(fd, IPPROTO_IP, IP_MULTICAST_IF, &imr_multiaddr, sizeof(imr_multiaddr));

    // 3.åˆå§‹åŒ–å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯
    struct sockaddr_in cliaddr;
    cliaddr.sin_family = AF_INET;
    cliaddr.sin_port = htons(9999);
    inet_pton(AF_INET, "239.0.0.10", &cliaddr.sin_addr.s_addr);

    // 3.é€šä¿¡
    int num = 0;
    while (1)
    {

        char sendBuf[128];
        sprintf(sendBuf, "hello, client....%d\n", num++);
        // å‘é€æ•°æ®
        sendto(fd, sendBuf, strlen(sendBuf) + 1, 0, (struct sockaddr *)&cliaddr, sizeof(cliaddr));
        printf("ç»„æ’­çš„æ•°æ®ï¼š%s\n", sendBuf);
        sleep(1);
    }

    close(fd);
    return 0;
}
```

```c
// multi_client.c

/*
    åˆ›å»ºsocket --> ï¼ˆæ³¨æ„ç»‘å®šçš„ä¿¡æ¯ï¼‰bind -->
    è®¾ç½®ç»„æ’­ipå’Œæœ¬åœ°ip --> åŠ å…¥å¤šæ’­ç»„åˆ° --> é€šä¿¡
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <arpa/inet.h>

int main()
{

    // 1.åˆ›å»ºä¸€ä¸ªé€šä¿¡çš„socket
    int fd = socket(PF_INET, SOCK_DGRAM, 0);
    if (fd == -1)
    {
        perror("socket");
        exit(-1);
    }

    struct in_addr in;
    // 2.å®¢æˆ·ç«¯ç»‘å®šæœ¬åœ°çš„IPå’Œç«¯å£
    struct sockaddr_in addr;
    addr.sin_family = AF_INET;
    addr.sin_port = htons(9999);
    addr.sin_addr.s_addr = INADDR_ANY;

    int ret = bind(fd, (struct sockaddr *)&addr, sizeof(addr));
    if (ret == -1)
    {
        perror("bind");
        exit(-1);
    }

    struct ip_mreq op;
    // è®¾ç½®ç»„æ’­çš„ IP åœ°å€
    inet_pton(AF_INET, "239.0.0.10", &op.imr_multiaddr.s_addr);
    // è®¾ç½®æœ¬åœ°çš„ IP åœ°å€
    op.imr_interface.s_addr = INADDR_ANY;

    // åŠ å…¥åˆ°å¤šæ’­ç»„
    setsockopt(fd, IPPROTO_IP, IP_ADD_MEMBERSHIP, &op, sizeof(op));

    // 3.é€šä¿¡
    while (1)
    {

        char buf[128];
        // æ¥æ”¶æ•°æ®
        int num = recvfrom(fd, buf, sizeof(buf), 0, NULL, NULL);
        printf("server say : %s\n", buf);
    }

    close(fd);
    return 0;
}
```



![å¤šæ’­ä»£ç è¿è¡Œå›¾](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å¤šæ’­ä»£ç è¿è¡Œå›¾.184jb54grlmo.webp)

## 4ã€æœ¬åœ°å¥—æ¥å­—

> * æœ¬åœ°å¥—æ¥å­—çš„ä½œç”¨ï¼šæœ¬åœ°çš„è¿›ç¨‹é—´é€šä¿¡ 
>   * æœ‰å…³ç³»çš„è¿›ç¨‹é—´çš„é€šä¿¡ 
>   * æ²¡æœ‰å…³ç³»çš„è¿›ç¨‹é—´çš„é€šä¿¡ 
> * æœ¬åœ°å¥—æ¥å­—å®ç°æµç¨‹å’Œç½‘ç»œå¥—æ¥å­—ç±»ä¼¼ï¼Œä¸€èˆ¬å‘¢é‡‡ç”¨TCPçš„é€šä¿¡æµç¨‹ã€‚

![ä¸“ç”¨-socket-åœ°å€](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ä¸“ç”¨-socket-åœ°å€.31lv2jsjyfu0.webp)

### 4.1 æœ¬åœ°å¥—æ¥å­—é€šä¿¡æµç¨‹

```c
// æœ¬åœ°å¥—æ¥å­—é€šä¿¡çš„æµç¨‹ - tcp
// æœåŠ¡å™¨ç«¯
1. åˆ›å»ºç›‘å¬çš„å¥—æ¥å­—
	int lfd = socket(AF_UNIX/AF_LOCAL, SOCK_STREAM, 0);
2. ç›‘å¬çš„å¥—æ¥å­—ç»‘å®šæœ¬åœ°çš„å¥—æ¥å­—æ–‡ä»¶ -> serverç«¯
	struct sockaddr_un addr;
	// ç»‘å®šæˆåŠŸä¹‹åï¼ŒæŒ‡å®šçš„sun_pathä¸­çš„å¥—æ¥å­—æ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚
	bind(lfd, addr, len);
3. ç›‘å¬
	listen(lfd, 100);
4. ç­‰å¾…å¹¶æ¥å—è¿æ¥è¯·æ±‚
	struct sockaddr_un cliaddr;
	int cfd = accept(lfd, &cliaddr, len);
5. é€šä¿¡
	æ¥æ”¶æ•°æ®ï¼šread/recv
	å‘é€æ•°æ®ï¼šwrite/send
6. å…³é—­è¿æ¥
	close();

// å®¢æˆ·ç«¯çš„æµç¨‹
1. åˆ›å»ºé€šä¿¡çš„å¥—æ¥å­—
	int fd = socket(AF_UNIX/AF_LOCAL, SOCK_STREAM, 0);
2. ç›‘å¬çš„å¥—æ¥å­—ç»‘å®šæœ¬åœ°çš„IP ç«¯å£
	struct sockaddr_un addr;
	// ç»‘å®šæˆåŠŸä¹‹åï¼ŒæŒ‡å®šçš„sun_pathä¸­çš„å¥—æ¥å­—æ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚
	bind(lfd, addr, len);
3. è¿æ¥æœåŠ¡å™¨
	struct sockaddr_un serveraddr;
	connect(fd, &serveraddr, sizeof(serveraddr));
4. é€šä¿¡
	æ¥æ”¶æ•°æ®ï¼šread/recv
	å‘é€æ•°æ®ï¼šwrite/send
5. å…³é—­è¿æ¥
	close();
```

```c
// å¤´æ–‡ä»¶: sys/un.h
#define UNIX_PATH_MAX 108
struct sockaddr_un {
sa_family_t sun_family; // åœ°å€æ—åè®® af_local
char sun_path[UNIX_PATH_MAX]; // å¥—æ¥å­—æ–‡ä»¶çš„è·¯å¾„, è¿™æ˜¯ä¸€ä¸ªâ—â—â—ä¼ªæ–‡ä»¶, å¤§å°æ°¸è¿œ=0
};
```



### 4.2 ä»£ç æ¡ˆä¾‹

```c
//ipc_server.c

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <arpa/inet.h>
#include <sys/un.h>

int main()
{

    //unlink("server.sock");

    // 1.åˆ›å»ºç›‘å¬çš„å¥—æ¥å­—
    int lfd = socket(AF_LOCAL, SOCK_STREAM, 0);
    if (lfd == -1)
    {
        perror("socket");
        exit(-1);
    }

    // 2.ç»‘å®šæœ¬åœ°å¥—æ¥å­—æ–‡ä»¶
    struct sockaddr_un addr;
    addr.sun_family = AF_LOCAL;
    // å¥—æ¥å­—æ–‡ä»¶çš„è·¯å¾„ï¼Œç”¨strcpy è®¾ç½®åˆ°addr.sun_path ä¸­
    strcpy(addr.sun_path, "server.sock");
    // ç»‘å®šæˆåŠŸä¹‹åï¼ŒæŒ‡å®šçš„sun_pathä¸­çš„å¥—æ¥å­—æ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚
    int ret = bind(lfd, (struct sockaddr *)&addr, sizeof(addr));
    if (ret == -1)
    {
        perror("bind");
        exit(-1);
    }

    // 3.ç›‘å¬
    ret = listen(lfd, 100);
    if (ret == -1)
    {
        perror("listen");
        exit(-1);
    }

    // 4.ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
    // cliaddr è®°å½•äº†è¿æ¥æˆåŠŸåå®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯
    struct sockaddr_un cliaddr;
    int len = sizeof(cliaddr);
    int cfd = accept(lfd, (struct sockaddr *)&cliaddr, &len);
    if (cfd == -1)
    {
        perror("accept");
        exit(-1);
    }

    printf("client socket filename: %s\n", cliaddr.sun_path);

    // 5.é€šä¿¡
    while (1)
    {

        char buf[128];
        int len = recv(cfd, buf, sizeof(buf), 0);

        if (len == -1)
        {
            perror("recv");
            exit(-1);
        }
        else if (len == 0)
        {
            printf("client closed....\n");
            break;
        }
        else if (len > 0)
        {
            printf("client say : %s\n", buf);
            send(cfd, buf, len, 0);
        }
    }

    close(cfd);
    close(lfd);

    return 0;
}
```



```c
//ipc_client.c

#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <arpa/inet.h>
#include <sys/un.h>

int main()
{

    //unlink("client.sock");

    // 1.åˆ›å»ºå¥—æ¥å­—
    int cfd = socket(AF_LOCAL, SOCK_STREAM, 0);
    if (cfd == -1)
    {
        perror("socket");
        exit(-1);
    }

    // 2.ç»‘å®šæœ¬åœ°å¥—æ¥å­—æ–‡ä»¶
    struct sockaddr_un addr;
    addr.sun_family = AF_LOCAL;
    // å¥—æ¥å­—æ–‡ä»¶çš„è·¯å¾„ï¼Œç”¨strcpy è®¾ç½®åˆ°addr.sun_path ä¸­
    strcpy(addr.sun_path, "client.sock");
    // ç»‘å®šæˆåŠŸä¹‹åï¼ŒæŒ‡å®šçš„sun_pathä¸­çš„å¥—æ¥å­—æ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚
    int ret = bind(cfd, (struct sockaddr *)&addr, sizeof(addr));
    if (ret == -1)
    {
        perror("bind");
        exit(-1);
    }

    // 3.è¿æ¥æœåŠ¡å™¨
    struct sockaddr_un seraddr;
    seraddr.sun_family = AF_LOCAL;
    strcpy(seraddr.sun_path, "server.sock");
    // seraddr å®¢æˆ·ç«¯è¦è¿æ¥çš„æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯
    ret = connect(cfd, (struct sockaddr *)&seraddr, sizeof(seraddr));
    if (ret == -1)
    {
        perror("connect");
        exit(-1);
    }

    // 4.é€šä¿¡
    int num = 0;
    while (1)
    {

        // å‘é€æ•°æ®
        char buf[128];
        sprintf(buf, "hello, i am client %d\n", num++);
        send(cfd, buf, strlen(buf) + 1, 0);
        printf("client say : %s\n", buf);

        // æ¥æ”¶æ•°æ®
        int len = recv(cfd, buf, sizeof(buf), 0);

        if (len == -1)
        {
            perror("recv");
            exit(-1);
        }
        else if (len == 0)
        {
            printf("server closed....\n");
            break;
        }
        else if (len > 0)
        {
            printf("server say : %s\n", buf);
        }

        sleep(1);
    }

    close(cfd);
    return 0;
}
```

### 4.3 è¿è¡Œç»“æœåˆ†æ

![æœ¬åœ°å¥—æ¥å­—è¿è¡Œç»“æœ](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/æœ¬åœ°å¥—æ¥å­—è¿è¡Œç»“æœ.a25nt9gm10.webp)

* æ‰“å¼€æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œå¼€å§‹é€šä¿¡ï¼Œå‘ç°ç”Ÿæˆäº† `server.sock` å’Œ `client.sock`æ–‡ä»¶ï¼Œä¸¤ä¸ªæ–‡ä»¶çš„**æ–‡ä»¶å¤§å°éƒ½ä¸º 0**ï¼Œå› ä¸ºéƒ½æ˜¯**ä¼ªæ–‡ä»¶**

* ğŸŸ¥ï¼šç»‘å®šæŠ¥é”™ï¼Œåœ°å€å·²è¢«å ç”¨ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ‰§è¡Œä¸€æ¬¡åå°±ç”Ÿæˆäº†å¥—æ¥å­—æ–‡ä»¶ï¼Œè¿™é‡Œçš„ç»‘å®šå¯ä»¥ç†è§£ä¸ºæ˜¯å’Œè¿™ä¸ªæ–‡ä»¶ç»‘å®šï¼Œæ–‡ä»¶åº”è¯¥åœ¨ç»‘å®šæˆåŠŸåç”Ÿæˆï¼Œå·²ç»æœ‰æ–‡ä»¶äº†å°±æŠ¥é”™

* æ‰€ä»¥è¦åœ¨æ¯æ¬¡æ‰§è¡Œä»£ç å‰éƒ½å»åˆ é™¤ä¹‹å‰ç”Ÿæˆçš„å¥—æ¥å­—æ–‡ä»¶ï¼š

  * ```c
    // unlink("client.sock");
    // unlink("server.sock");
    //å³ä¸Šé¢ä¸¤ä¸ªä»£ç å¼€å¤´æ³¨é‡Šæ‰çš„è¯­å¥
    ```

    
