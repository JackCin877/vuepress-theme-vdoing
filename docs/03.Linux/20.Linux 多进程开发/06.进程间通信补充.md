---
title: è¿›ç¨‹é—´é€šä¿¡è¡¥å……
date: 2023-09-12 17:03:37
permalink: /pages/6c675f/
categories:
  - Linux
  - Linux å¤šè¿›ç¨‹å¼€å‘
tags:
  - 
author: 
  name: JackCin
  link: https://github.com/JackCin877
---
# è¿›ç¨‹é—´é€šä¿¡

## ä¸€ã€è¿›ç¨‹é—´é€šä¿¡

### 1.è¿›ç¨‹è§é€šä¿¡æ¦‚è¿°

* UNIXå¹³å°è¿›ç¨‹é€šä¿¡æ–¹å¼ 
  * æ—©æœŸè¿›ç¨‹é—´é€šä¿¡æ–¹å¼
    * **ç®¡é“ã€æœ‰åç®¡é“å’Œä¿¡å·** 
  *  AT&Tçš„è´å°”å®éªŒå®¤ â€¢
    * å¯¹Unixæ—©æœŸçš„è¿›ç¨‹é—´é€šä¿¡è¿›è¡Œäº†æ”¹è¿›å’Œæ‰©å……ï¼Œå½¢æˆäº†â€œ**system V IPC**â€ï¼Œå…¶é€šä¿¡è¿› ç¨‹ä¸»è¦å±€é™åœ¨**å•ä¸ªè®¡ç®—æœºå†…** 
  * BSD(åŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„ä¼¯å…‹åˆ©è½¯ä»¶å‘å¸ƒä¸­å¿ƒ) 
    * å½¢æˆäº†åŸºäº**å¥—æ¥å­—(socket)**çš„è®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ 
* Linuxç»§æ‰¿äº†ä¸Šè¿°æ‰€æœ‰çš„é€šä¿¡æ–¹å¼





### 2.Linuxä¸‹è¿›ç¨‹é—´é€šä¿¡æ¦‚è¿°

* å¸¸ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ 
  * ä¼ ç»Ÿçš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ 
    * **æ— åç®¡é“(pipe)ã€æœ‰åç®¡é“(fifo)å’Œä¿¡å·(signal)** 
  * System V IPCå¯¹è±¡ 
    * **å…±äº«å†…å­˜(share memory)ã€æ¶ˆæ¯é˜Ÿåˆ—(message queue)å’Œä¿¡å·ç¯ (semaphore)** 
  * BSD 
    * **å¥—æ¥å­—(socket)**



### 3.IPC å¯¹è±¡

* IPC(Inter-Process Communication) è¿›ç¨‹é—´é€šä¿¡ï¼Œæ ä¾›äº†å„ç§è¿›ç¨‹é—´é€šä¿¡çš„æ–¹æ³•

![561bdc422193dc78c48a4020a9b14dd](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/561bdc422193dc78c48a4020a9b14dd.3r1h9zgxdr60.webp)

ä¸¾ä¾‹ï¼š

![IPCå¯¹è±¡ä¾‹å­](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/IPCå¯¹è±¡ä¾‹å­.4uwovv25sy20.webp)

* ğŸŸ©å¯ä»¥ä¸è¦ï¼Œç„¶åç›´æ¥å°† `shmget` å‡½æ•°é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°å†™ä¸º `IPC_PRIVATE` è¿™ä¸ªå®

### 4.æŸ¥çœ‹ IPC å¯¹è±¡

* 1.ipcså‘½ä»¤ç”¨äºæŸ¥çœ‹ç³»ç»Ÿä¸­çš„IPCå¯¹è±¡ 

  * 1. `ipcs â€“m` å…±äº«å†…å­˜ 
  * 2. `ipcs â€“s` ä¿¡å·é‡ 
  * 3. `ipcs â€“q` æ¶ˆæ¯é˜Ÿåˆ— 

* 2.ipcrmå‘½ä»¤ç”¨äº**åˆ é™¤ç³»ç»Ÿä¸­çš„IPCå¯¹è±¡**

   `ipcrm â€“m id`

* â—â—â— **åˆ›å»ºçš„IPCå¯¹è±¡å¦‚æœä¸åˆ é™¤çš„è¯ä¼šä¸€ç›´ä¿ç•™åœ¨ç³»ç»Ÿä¸­**
  * æ¯”å¦‚ï¼šæˆ‘ä»¬æˆåŠŸåˆ›å»ºäº†ä¸€æ¬¡ä¿¡å·é›†ï¼Œç„¶åè¦è¿›è¡Œä¿®æ”¹ï¼ˆæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºçš„ä¿¡å·é›†é‡Œåªæœ‰1ä¸ªä¿¡å·ç¯ï¼Œç„¶åæˆ‘ä»¬è¦æ”¹ä¸ºä¸¤ä¸ªï¼‰ï¼Œé‚£æˆ‘ä»¬éœ€è¦å…ˆå°†ä¹‹å‰åˆ›å»ºçš„ä¿¡å·é›†åˆ é™¤

![ipcs-æŸ¥çœ‹ipcå¯¹è±¡](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ipcs-æŸ¥çœ‹ipcå¯¹è±¡.4acc95wyid60.webp)



## äºŒã€å…±äº«å†…å­˜

### 1. å…±äº«å†…å­˜æ¦‚è¿°

* å…±äº«å†…å­˜æ˜¯ä¸€ç§**æœ€ä¸ºé«˜æ•ˆ**çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ï¼Œè¿›ç¨‹å¯ä»¥ç›´æ¥è¯»å†™å†…å­˜ï¼Œè€Œä¸éœ€è¦ä»»ä½•æ•° æ®çš„æ‹·è´ 
* ä¸ºäº†åœ¨å¤šä¸ªè¿›ç¨‹é—´äº¤æ¢ä¿¡æ¯ï¼Œ**å†…æ ¸**ä¸“é—¨ç•™å‡ºäº†ä¸€å—å†…å­˜åŒºï¼Œå¯ä»¥ç”±éœ€è¦è®¿é—®çš„è¿›ç¨‹å°†å…¶ **æ˜ å°„åˆ°è‡ªå·±çš„ç§æœ‰åœ°å€ç©ºé—´** 
* è¿›ç¨‹å°±å¯ä»¥**ç›´æ¥è¯»å†™**è¿™ä¸€å†…å­˜åŒºè€Œä¸éœ€è¦è¿›è¡Œæ•°æ®çš„æ‹·è´ï¼Œä»è€Œå¤§å¤§æé«˜çš„æ•ˆç‡ã€‚ 
* ç”±äºå¤šä¸ªè¿›ç¨‹å…±äº«ä¸€æ®µå†…å­˜ï¼Œå› æ­¤ä¹Ÿéœ€è¦ä¾é æŸç§åŒæ­¥æœºåˆ¶ï¼Œå¦‚**äº’æ–¥é”**å’Œ**ä¿¡å·é‡**ç­‰

### 2. å…±äº«å†…å­˜å®ç°

1. åˆ›å»º/æ‰“å¼€å…±äº«å†…å­˜ 
2. æ˜ å°„å…±äº«å†…å­˜ï¼Œå³æŠŠæŒ‡å®šçš„å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ ç”¨äºè®¿é—® 
3. æ’¤é”€å…±äº«å†…å­˜æ˜ å°„ 
4. åˆ é™¤å…±äº«å†…å­˜å¯¹è±¡

### 3.å…±äº«å†…å­˜å‡½æ•°è°ƒç”¨æµç¨‹

![å…±äº«å†…å­˜å‡½æ•°è°ƒç”¨æµç¨‹](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å…±äº«å†…å­˜å‡½æ•°è°ƒç”¨æµç¨‹.4xkhvrcpbvc0.webp)

### 3ã€å…±äº«å†…å­˜å‡½æ•°

#### 3.1 shmget()

* åˆ›å»º/æ‰“å¼€å…±äº«å†…å­˜

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

- int shmget(key_t key, int size, int shmflg);
	-å‚æ•° 
        - keyï¼š IPC_PRIVATE æˆ– ftokçš„è¿”å›å€¼
		- sizeï¼šå…±äº«å†…å­˜åŒºå¤§å°
		- shmflgï¼šåŒopenå‡½æ•°çš„æƒé™ä½ï¼Œä¹Ÿå¯ä»¥ç”¨8è¿›åˆ¶è¡¨ç¤ºæ³•
	- è¿”å›å€¼ 
        - æˆåŠŸï¼šå…±äº«å†…å­˜æ®µæ ‡è¯†ç¬¦
		- å‡ºé”™ï¼š-1
```

#### 3.2 shmat()

* å°†å…±äº«å†…å­˜ä¸å½“å‰è¿›ç¨‹ç›¸å…³è”

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
- void *shmat(int shmid, const void *shmaddr, int shmflg);
	- å‚æ•° 
		- shmidï¼šè¦æ˜ å°„çš„å…±äº«å†…å­˜åŒºæ ‡è¯†ç¬¦
		- shmaddrï¼šå°†å…±äº«å†…å­˜æ˜ å°„åˆ°æŒ‡å®šåœ°å€(è‹¥ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºç”±ç³»ç»Ÿè‡ªåŠ¨å®Œæˆæ˜ å°„)
		- shmflg : 
			- SHM_RDONLYï¼šå…±äº«å†…å­˜åªè¯»
			- é»˜è®¤0ï¼šå…±äº«å†…å­˜å¯è¯»å†™
	- è¿”å›å€¼ 
		- æˆåŠŸï¼šæ˜ å°„åçš„åœ°å€
		- å‡ºé”™ï¼š-1
```

#### 3.3 shmdt()

* å°†å½“å‰è¿›ç¨‹ä¸å…±äº«å†…å­˜é—´è„±ç¦»å…³è”

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
- int shmdt(const void *shmaddr);
	- å‚æ•° shmaddrï¼šå…±äº«å†…å­˜æ˜ å°„åçš„åœ°å€
	- è¿”å›å€¼ 
        - æˆåŠŸï¼š0
		- å‡ºé”™ï¼š-1
```

#### 3.4 shmctl()

* æ“æ§å…±äº«å†…å­˜

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int shmctl(int shmid, int cmd, struct shmid_ds *buf);
	- å‚æ•° 
        - shmidï¼šè¦æ“ä½œçš„å…±äº«å†…å­˜æ ‡è¯†ç¬¦
        - cmd : 
			- IPC_STAT (è·å–å¯¹è±¡å±æ€§)
            - IPC_SET (è®¾ç½®å¯¹è±¡å±æ€§)
			- IPC_RMID (åˆ é™¤å¯¹è±¡)
		- buf : æŒ‡å®šIPC_STAT/IPC_SETæ—¶ç”¨ä»¥ä¿å­˜/è®¾ç½®å±æ€§
	- è¿”å›å€¼ 
        - æˆåŠŸï¼š0
		- å‡ºé”™ï¼š-1
```

#### 3.5 ä»£ç 

![å…±äº«å†…å­˜ä»£ç ](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å…±äº«å†…å­˜ä»£ç .6pztdzht1mg0.webp)

## ä¸‰ã€æ¶ˆæ¯é˜Ÿåˆ—

### 1ã€æ¶ˆæ¯é˜Ÿåˆ—æ¦‚å¿µ

* æ¶ˆæ¯é˜Ÿåˆ—æ˜¯IPCå¯¹è±¡çš„ä¸€ç§ 
* æ¶ˆæ¯é˜Ÿåˆ—ç”±æ¶ˆæ¯é˜Ÿåˆ—IDæ¥å”¯ä¸€æ ‡è¯† 
* æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯çš„åˆ—è¡¨ã€‚ç”¨æˆ·å¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ æ·»åŠ æ¶ˆæ¯ã€è¯»å–æ¶ˆæ¯ç­‰ã€‚ 
* æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥æŒ‰ç…§ç±»å‹æ¥å‘é€/æ¥æ”¶æ¶ˆæ¯

### 2ã€æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹

![æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹.43u3eisiy3s0.webp)

### 3ã€æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹

![æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/æ¶ˆæ¯é˜Ÿåˆ—æµç¨‹.2qmfjhwpvue0.webp)

### 4ã€æ¶ˆæ¯é˜Ÿåˆ—å‡½æ•°

#### 4.1 msgget()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgget(key_t key, int flag);
	- å‚æ•° 
        - keyï¼šå’Œæ¶ˆæ¯é˜Ÿåˆ—å…³è”çš„keyå€¼
		- flagï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„è®¿é—®æƒé™
        	- IPC_CREAT ï¼šå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¹‹ï¼Œå¦åˆ™åˆ™è¿›è¡Œæ‰“å¼€æ“ä½œ;
			- IPC_EXCLï¼šå’ŒIPC_CREAT ä¸€èµ·ä½¿ç”¨ï¼ˆç”¨â€|â€è¿æ¥ï¼‰ï¼Œå¦‚æœæ¶ˆæ¯å¯¹è±¡ä¸å­˜åœ¨åˆ™åˆ›å»ºä¹‹ï¼Œå¦åˆ™äº§ç”Ÿä¸€ä¸ªé”™è¯¯å¹¶è¿”å›ã€‚
	- è¿”å›å€¼ 
        - æˆåŠŸï¼šæ¶ˆæ¯é˜Ÿåˆ—ID
		- å‡ºé”™ï¼š-1
```

#### 4.2 msgsnd()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgsnd(int msqid, const void *msgp, size_t size, int flag);
	- å‚æ•° 
        - msqidï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„ID
		- msgpï¼šæŒ‡å‘æ¶ˆæ¯çš„æŒ‡é’ˆã€‚å¸¸ç”¨æ¶ˆæ¯ç»“æ„msgbufå¦‚ä¸‹ï¼š
        	- struct msgbuf{
            	long mtype; //æ¶ˆæ¯ç±»å‹
            	char mtext[N] //æ¶ˆæ¯æ­£æ–‡
       		 	}ï¼› 
        
		- sizeï¼šâ—â—â—å‘é€çš„æ¶ˆæ¯æ­£æ–‡çš„å­—èŠ‚æ•°
		- flagï¼š 
			- IPC_NOWAIT æ¶ˆæ¯æ²¡æœ‰å‘é€å®Œæˆå‡½æ•°ä¹Ÿä¼šç«‹å³è¿”å›ã€‚
			- 0ï¼šç›´åˆ°å‘é€å®Œæˆå‡½æ•°æ‰è¿”å›
	- è¿”å›å€¼ 
        - æˆåŠŸï¼š0
		- å‡ºé”™ï¼š-1
```

#### 4.3 msgrcv()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgrcv(int msgid, void* msgp, size_t size, long msgtype, int flag);
	- å‚æ•° 
        - msqidï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„ID
		- msgpï¼šæ¥æ”¶æ¶ˆæ¯çš„ç¼“å†²åŒº
		- sizeï¼šè¦æ¥æ”¶çš„æ¶ˆæ¯çš„å­—èŠ‚æ•°(åŒ…æ‹¬äº†æ¶ˆæ¯ç±»å‹å’Œæ­£æ–‡)
		- msgtypeï¼š 
        	- 0ï¼šæ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚
        	- å¤§äº0ï¼šæ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç±»å‹ä¸ºmsgtypçš„æ¶ˆæ¯.
        	- å°äº0ï¼šæ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç±»å‹å€¼ä¸å°äºmsgtypçš„ç»å¯¹å€¼ä¸”ç±»å‹å€¼åˆæœ€å°çš„æ¶ˆæ¯ã€‚
		- flagï¼š 
        	- 0ï¼šè‹¥æ— æ¶ˆæ¯å‡½æ•°ä¼šä¸€ç›´é˜»å¡
			- IPC_NOWAITï¼šè‹¥æ²¡æœ‰æ¶ˆæ¯ï¼Œè¿›ç¨‹ä¼šç«‹å³è¿”å›ENOMSGã€‚
	- è¿”å›å€¼ 
        - æˆåŠŸï¼šæ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„é•¿åº¦
		- å‡ºé”™ï¼š-1
```

#### 4.4 msgctl()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>

int msgctl ( int msgqid, int cmd, struct msqid_ds *buf );
	- å‚æ•° 
        - msqidï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„é˜Ÿåˆ—ID
		- cmdï¼š 
        	- IPC_STATï¼šè¯»å–æ¶ˆæ¯é˜Ÿåˆ—çš„å±æ€§ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨bufæŒ‡å‘çš„ç¼“å†²åŒºä¸­ã€‚
			- IPC_SETï¼šè®¾ç½®æ¶ˆæ¯é˜Ÿåˆ—çš„å±æ€§ã€‚è¿™ä¸ªå€¼å–è‡ªbufå‚æ•°ã€‚
			- IPC_RMIDï¼šä»ç³»ç»Ÿä¸­åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ã€‚
		- bufï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²åŒº
	- è¿”å›å€¼ 
        - æˆåŠŸï¼š0
		- å‡ºé”™ï¼š-1
```

#### 4.5 ä»£ç 

```c
// msq_client.c
#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/stat.h>

#define QUEUE_MSG_LEN	256
#define PROJ_ID		'g'
#define PATH_NAME	"/app"
#define SERVER_MSG	1
#define CLIENT_MSG	2
/*message data structure */
struct msg 
{
	long type;
	long msgtype;
	unsigned char text[QUEUE_MSG_LEN];

};

int main(void)
{
	int qid;
	int msglen;
	int i=0;
	struct msg msg_buf;

	/* get a message queue */
	key_t msgkey;
	if ((msgkey = ftok(PATH_NAME, PROJ_ID)) == -1) //ï¿½Ãµï¿½IDï¿½ï¿½
	{
		perror("ftok error!\n");
		exit(1);
	}
	if ((qid = msgget(msgkey, IPC_CREAT | 0666)) == -1) 
	{
		perror("msgget error!\n");
		exit(1);
	}

	while (1) 
	{
		/*receive message from message queue with SERVER_MSG type */
		if (msgrcv(qid, &msg_buf, sizeof(struct msg) - sizeof(long), SERVER_MSG, 0) == -1) 
		{
			perror("Server msgrcv error!\n");
			exit(1);
		}
		printf("server rcv : %ld: %s\n",msg_buf.msgtype,msg_buf.text);	
#if 1
		printf("client send: ");

		/*get string from terminal & fill up message data structure */
		fgets(msg_buf.text, QUEUE_MSG_LEN, stdin);
		if (strncmp("exit", msg_buf.text, 4) == 0) 
		{
			break;
		}
		msg_buf.text[strlen(msg_buf.text) - 1] = '\0';
		msg_buf.type = CLIENT_MSG;
		msg_buf.msgtype = i++;

		/*send message to message queue with CLIENT_MSG type */
		if (msgsnd(qid, &msg_buf, strlen(msg_buf.text) +  sizeof(long), 0) == -1) 
		{
			perror("client msgsnd error!\n");
			exit(1);
		}
		#endif
	}
	exit(0);
}
```

```c
// msq_server.c

#include<stdio.h>
#include<fcntl.h>
#include<stdlib.h>
#include<string.h>
#include<sys/types.h>
#include<sys/ipc.h>
#include<sys/msg.h>
#include<sys/stat.h>

#define QUEUE_MSG_LEN	256
#define PROJ_ID		'g'
#define PATH_NAME	"/app"
#define SERVER_MSG	1
#define CLIENT_MSG	2
/*message data structure */
struct msg 
{
	long type;
	long msgtype;
	unsigned char text[QUEUE_MSG_LEN];

};

int main(void)
{
	/*message data structure */
	struct msg msg_buf;

	int qid;
	int msglen;
	int i=0;
	/*get message queue */
	key_t msgkey;
	if ((msgkey = ftok(PATH_NAME, PROJ_ID)) == -1) 
	{
		perror("ftok error!\n");
		exit(1);
	}
	if ((qid = msgget(msgkey, IPC_CREAT | 0666)) == -1) 
	{
		perror("msgget error!\n");
		exit(1);
	}

	while (1) 
	{
		printf("server send: ");
		/*get string from terminal & fill up message data structure */
		fgets(msg_buf.text, QUEUE_MSG_LEN, stdin);
		if (strncmp("exit", msg_buf.text, 4) == 0) 
		{
			msgctl(qid, IPC_RMID, NULL);
			break;
		}
		msg_buf.text[strlen(msg_buf.text) - 1] = '\0';
		msg_buf.type = SERVER_MSG;
		msg_buf.msgtype = i++;

		/*send message to message queue with SERVER_MSG type */
		if (msgsnd(qid, &msg_buf, sizeof(struct msg) - sizeof(long), 0) == -1) 
		{
			perror("Server msgsnd error!\n");
			exit(1);
		}
#if 1
		/*receive message from message queue with CLIENT_MSG type */
		if (msgrcv(qid, &msg_buf, sizeof(struct msg) - sizeof(long), CLIENT_MSG, 0) == -1) 
		{
			perror("Server msgrcv error!\n");
			exit(1);
		}
		printf("server rcv: %d: %s\n",msg_buf.msgtype,msg_buf.text);
#endif		
	}

	exit(0);
}

```



## å››ã€ä¿¡å·ç¯

### 1ã€ ä¸´ç•Œèµ„æº

* **ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºç§°ä¸ºä¸´ç•Œèµ„æºï¼›** 
  * ä¸´ç•Œèµ„æºå¹¶ä¸å…¨æ˜¯`ç¡¬ä»¶`æˆ–æ˜¯`è½¯ä»¶`ï¼Œè€Œæ˜¯ä¸¤è€…**éƒ½èƒ½ä½œä¸ºä¸´ç•Œèµ„æº**ã€‚ 
  * æ¯”å¦‚ç¡¬ä»¶çš„æœ‰ï¼š 
    *  æ‰“å°æœºã€ç£å¸¦æœºç­‰ï¼› 
  * è½¯ä»¶æœ‰ï¼š 
    * æ¶ˆæ¯ç¼“å†²é˜Ÿåˆ—ã€å˜é‡ã€æ•°ç»„ã€ç¼“å†²åŒºç­‰ï¼› 
*  **ä¸´ç•ŒåŒºï¼ˆcritical regionï¼‰** 
  * **è®¿é—®å…±äº«å˜é‡çš„ç¨‹åºä»£ç æ®µç§°ä¸ºä¸´ç•ŒåŒºï¼Œä¹Ÿç§°ä¸ºä¸´ç•Œæ®µï¼ˆcritical  sectionï¼‰**; 
* è¿›ç¨‹äº’æ–¥ 
  * **ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ä¸èƒ½åŒæ—¶è¿›å…¥å…³äºåŒä¸€ç»„å…±äº«å˜é‡çš„ä¸´ç•ŒåŒºï¼Œå¦å¯ å¯èƒ½ä¼šå‘ç”Ÿä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯ï¼Œè¿™ç§ç°è±¡ç§°ä¸ºè¿›ç¨‹äº’æ–¥ï¼›**

### 2ã€ä¿¡å·ç¯

* ä¿¡å·ç¯(semaphore)ï¼Œä¹Ÿå«ä¿¡å·é‡ã€‚å®ƒæ˜¯**ä¸åŒè¿›ç¨‹**é—´æˆ– ä¸€ä¸ªç»™å®šè¿›ç¨‹å†…éƒ¨**ä¸åŒçº¿ç¨‹é—´**åŒæ­¥çš„æœºåˆ¶ã€‚ 
* ä¿¡å·ç¯ç§ç±»ï¼š 
  * posixæœ‰åä¿¡å·ç¯(å¯ç”¨äºçº¿ç¨‹ã€è¿›ç¨‹åŒæ­¥)
  * posixåŸºäºå†…å­˜çš„ä¿¡å·ç¯(æ— åä¿¡å·ç¯) 
  * **System Vä¿¡å·ç¯(IPCå¯¹è±¡)** 

### 3ã€ System V ä¿¡å·ç¯

* System Vçš„ä¿¡å·ç¯æ˜¯ä¸€ä¸ªæˆ–è€…å¤šä¸ªä¿¡å·ç¯çš„ä¸€ä¸ªé›†åˆã€‚ å…¶ä¸­çš„æ¯ä¸€ä¸ªéƒ½æ˜¯å•ç‹¬çš„è®¡æ•°ä¿¡å·ç¯ã€‚ 
* è€ŒPosixä¿¡å·ç¯æŒ‡çš„æ˜¯å•ä¸ªè®¡æ•°ä¿¡å·ç¯ 
* System V ä¿¡å·ç¯ç”±å†…æ ¸ç»´æŠ¤

### 4ã€äºŒå€¼ã€è®¡æ•°ä¿¡å·ç¯

* äºŒå€¼ä¿¡å·ç¯ï¼š 
  * å€¼ä¸º0æˆ–1ã€‚ä¸äº’æ–¥é”ç±»ä¼¼ï¼Œèµ„æºå¯ç”¨æ—¶å€¼ä¸º1ï¼Œä¸å¯ç”¨æ—¶å€¼ä¸º 0ã€‚ 
* è®¡æ•°ä¿¡å·ç¯ï¼š 
  * å€¼åœ¨0åˆ°nä¹‹é—´ã€‚ç”¨æ¥ç»Ÿè®¡èµ„æºï¼Œå…¶å€¼ä»£è¡¨å¯ç”¨èµ„æºæ•°

### 5ã€P\V æ“ä½œ

* é€šå¸¸æŠŠä¿¡å·é‡æ“ä½œæŠ½è±¡æˆPVæ“ä½œ
  *  P ï¼šç­‰å¾…æ“ä½œæ˜¯ç­‰å¾…ä¿¡å·ç¯çš„å€¼å˜ä¸ºå¤§äº0ï¼Œç„¶åå°†å…¶å‡1
  *  V  ï¼šé‡Šæ”¾æ“ä½œåˆ™ç›¸åï¼Œç”¨æ¥å”¤é†’ç­‰å¾…èµ„æºçš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹ 

### 6ã€ä¿¡å·ç¯å‡½æ•°

#### 6.1 semget()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>

int semget(key_t key, int nsems, int semflg);
	- å‚æ•° 
        - keyï¼šå’Œä¿¡å·ç¯é›†å…³è”çš„keyå€¼
		- nsems: ä¿¡å·ç¯é›†ä¸­åŒ…å«çš„ä¿¡å·ç¯æ•°ç›®
		- semflgï¼šä¿¡å·ç¯é›†çš„è®¿é—®æƒé™ï¼Œé€šå¸¸ä¸ºIPC_CREAT | 0666
	- è¿”å›å€¼ 
    	- æˆåŠŸï¼šä¿¡å·ç¯é›†ID
		- å‡ºé”™ï¼š-1
```



#### 6.2 semctl()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
- int semctl ( int semid, int semnum, int cmdâ€¦/*union semun arg*/);
	- å‚æ•° 
		- semidï¼šä¿¡å·ç¯é›†ID
		- semnum: è¦ä¿®æ”¹çš„ä¿¡å·ç¯ç¼–å·
		- cmdï¼š 
			- GETVALï¼šè·å–ä¿¡å·ç¯çš„å€¼
			- SETVALï¼šè®¾ç½®ä¿¡å·ç¯çš„å€¼
			- IPC_RMIDï¼šä»ç³»ç»Ÿä¸­åˆ é™¤ä¿¡å·ç¯é›†åˆ
            
union semun {
	short val; /*SETVALç”¨çš„å€¼*/
	struct semid_ds* buf; /*IPC_STATã€IPC_SETç”¨çš„semid_dsç»“æ„*/
	unsigned short* array; /*SETALLã€GETALLç”¨çš„æ•°ç»„å€¼*/
	struct seminfo *buf; /*ä¸ºæ§åˆ¶IPC_INFOæä¾›çš„ç¼“å­˜*/
} arg;

	- è¿”å›å€¼ 
        - æˆåŠŸï¼š0
		- å‡ºé”™ï¼š-1é”™è¯¯åŸå› å­˜äºerrnoä¸­
```



#### 6.3 semctl()

```c
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>

int semop ( int semid, struct sembuf *opsptr, size_t nops);
	- å‚æ•° 
		- semidï¼šä¿¡å·ç¯é›†ID
        - struct sembuf {
        	short sem_num; // è¦æ“ä½œçš„ä¿¡å·ç¯çš„ç¼–å·
        	short sem_op; // 0 : ç­‰å¾…ï¼Œç›´åˆ°ä¿¡å·ç¯çš„å€¼å˜æˆ0
        				  // 1 : é‡Šæ”¾èµ„æºï¼ŒVæ“ä½œ
        				  // -1 : åˆ†é…èµ„æºï¼ŒPæ“ä½œ
       	 	short sem_flg; // 0, IPC_NOWAIT, SEM_UNDO
        };
		- nops: è¦æ“ä½œçš„ä¿¡å·ç¯çš„ä¸ªæ•°

	- è¿”å›å€¼ 
		- æˆåŠŸï¼š0
		- å‡ºé”™ï¼š-1
```

### 7ã€ä¿¡å·ç¯å‡½æ•°ä½¿ç”¨

![ä¿¡å·ç¯å‡½æ•°ä½¿ç”¨](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ä¿¡å·ç¯å‡½æ•°ä½¿ç”¨.6d3gkal1juo0.webp)

```c
// sem.h
#ifndef __SEM_H__
#define __SEM_H__

#if 0
union semun {
	int              val;    /* Value for SETVAL */
	struct semid_ds *buf;    /* Buffer for IPC_STAT, IPC_SET */
	unsigned short  *array;  /* Array for GETALL, SETALL */
	struct seminfo  *__buf;  /* Buffer for IPC_INFO
								(Linux-specific) */
};
#endif
int init_sem(int semid, int num, int val)
{
	union semun myun;
	myun.val = val;
	if(semctl(semid, num, SETVAL, myun) < 0)
	{
		perror("semctl");
		exit(1);
	}
	return 0;
}

int sem_p(int semid, int num)
{
	struct sembuf mybuf;
	mybuf.sem_num = num;
	mybuf.sem_op = -1;
	mybuf.sem_flg = SEM_UNDO;
	if(semop(semid, &mybuf, 1) < 0)
	{
		perror("semop");
		exit(1);
	}

	return 0;
}

int sem_v(int semid, int num)
{
	struct sembuf mybuf;
	mybuf.sem_num = num;
	mybuf.sem_op = 1;
	mybuf.sem_flg = SEM_UNDO;
	if(semop(semid, &mybuf, 1) < 0)
	{
		perror("semop");
		exit(1);
	}

	return 0;
}

#endif

```

```c
// sem_client.c

#include <sys/types.h>
#include <linux/sem.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include "sem.h"

int main(void)
{
	key_t key;   //sem key
	int semid, semval;

	//get semaphore
	if((key = ftok("/app",'i')) <0)
	{
		perror("ftok");
		exit(1);
	}
	printf("key = %x\n",key);

	if((semid  = semget(key, 1, 0666)) < 0)
	{
		perror("semget");
		exit(1);
	}

	//get semaphore value every 1 seconds  
	while (1) 
	{
		if ((semval = semctl(semid, 0, GETVAL, 0)) == -1) 
		{
			perror("semctl error!\n");
			exit(1);
		}

		if (semval > 0) 
		{
			printf("Still %d resources can be used\n", semval);
		}else 
		{
			printf("No more resources can be used!\n");
			//break;
		}
		sleep(1);
	}
	exit(0);
}

```

```c
// sem_server.c
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <linux/sem.h>
#include <stdio.h>
#include <errno.h>

#include "sem.h"

#define MAX_RESOURCE    10

int main(void)
{
	key_t key_info;
	int semid;

	//get semaphore 
	if ((key_info = ftok ("/app", 'i')) < 0)
	{
		perror ("ftok info");
		exit (-1);
	}

	
	printf("key is %d\n", key_info);

	if ((semid = semget (key_info, 1, IPC_CREAT | IPC_EXCL |0666)) < 0)
	{
		if (errno == EEXIST)
		{
			semid = semget (key_info, 1, 0666);
		}
		else
		{
			perror ("semget");
			exit (-1);
		}
	}
	else
	{
		init_sem (semid, 0, 1);
	}

	//substract 1 every 3 seconds until semaphore value is -1
	while (1) 
	{
		//p
		printf("p\n");
		sem_p (semid, 0);
		//è¿›å…¥ä¸´ç•ŒåŒº
		sleep(4);
		//V
		printf("v\n");
		sem_v (semid, 0);
		sleep(3);
	}
	exit(0);
}

```

### 8ã€ä¿¡å·é‡ä¸å…±äº«å†…å­˜

![ä¿¡å·é‡ä¸å…±äº«å†…å­˜](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/ä¿¡å·é‡ä¸å…±äº«å†…å­˜.kfu68rrnkxs.webp)

## äº”ã€è¿›ç¨‹é—´é€šä¿¡æ–¹å¼æ¯”è¾ƒ

| é€šä¿¡æ–¹å¼        | ç‰¹ç‚¹                                                 |
| --------------- | ---------------------------------------------------- |
| signal ä¿¡å·æ•æ‰ | å”¯ä¸€çš„å¼‚æ­¥é€šä¿¡æ–¹å¼                                   |
| msg æ¶ˆæ¯é˜Ÿåˆ—    | å¸¸ç”¨äºcsæ¨¡å¼ä¸­ï¼Œ æŒ‰**æ¶ˆæ¯ç±»å‹è®¿é—®** ï¼Œ**å¯æœ‰ä¼˜å…ˆçº§** |
| shm å…±äº«å†…å­˜    | **æ•ˆç‡æœ€é«˜(ç›´æ¥è®¿é—®å†…å­˜)** ï¼Œéœ€è¦åŒæ­¥ã€äº’æ–¥æœºåˆ¶      |
| sem ä¿¡å·ç¯      | **é…åˆå…±äº«å†…å­˜ä½¿ç”¨**ï¼Œç”¨ä»¥å®ç°åŒæ­¥å’Œäº’æ–¥             |
| pipe åŒ¿åç®¡é“   | å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ï¼Œå•å·¥ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­             |
| fifo  æœ‰åç®¡é“  | å¯ç”¨äºä»»æ„è¿›ç¨‹é—´ï¼ŒåŒå·¥ï¼Œæœ‰æ–‡ä»¶åï¼Œæ•°æ®åœ¨å†…å­˜         |

