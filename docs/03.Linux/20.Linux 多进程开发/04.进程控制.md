---
title: è¿›ç¨‹æ§åˆ¶
date: 2023-09-12 17:03:37
permalink: /pages/e61d0e/
categories:
  - Linux
  - Linux å¤šè¿›ç¨‹å¼€å‘
tags:
  - 
author: 
  name: JackCin
  link: https://github.com/JackCin877
---
# è¿›ç¨‹æ§åˆ¶

## 1ã€è¿›ç¨‹é€€å‡º

![exitå‡½æ•°](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/exitå‡½æ•°.8sktip9cbig.webp)

```c
#include <stdlib.h>
void exit(int status);
#include <unistd.h>
void _exit(int status);
statuså‚æ•°ï¼šæ˜¯è¿›ç¨‹é€€å‡ºæ—¶å¾—ä¸€ä¸ªçŠ¶æ€ä¿¡æ¯ã€‚çˆ¶è¿›ç¨‹å›æ”¶å­è¿›ç¨‹èµ„æºå¾—æ—¶å€™å¯ä»¥è·å–åˆ°ã€‚
```

```c
//exit.c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main()
{
    printf("hello\n");
    printf("world");

    // exit(0);
    _exit(0);

    return 0;
}
```

![exitå‡½æ•°](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/exitå‡½æ•°.5m5l835qv680.webp)

* ğŸŸ¨ï¼šå› ä¸º`exit()`ä¼šåˆ·æ–°äº† I/O ç¼“å†²ï¼Œæ‰€ä»¥ä¼šå…¨éƒ¨æ‰“å°å‡ºæ¥
* ğŸŸ¥ï¼šè¿™é‡Œç”¨çš„æ˜¯`_exit()` å‡½æ•°ï¼Œé‡åˆ° `\n`ï¼ˆæ¢è¡Œç¬¦ï¼‰ æ‰åˆ·æ–°ç¼“å†²åŒºï¼Œæ‰€ä»¥ä½¿ç”¨ `_exit()` å°±åªæ‰“å°äº† hello

## 2ã€å­¤å„¿è¿›ç¨‹

* **çˆ¶è¿›ç¨‹è¿è¡Œç»“æŸï¼Œä½†å­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼ˆæœªè¿è¡Œç»“æŸï¼‰ï¼Œè¿™æ ·çš„å­è¿›ç¨‹å°±ç§°ä¸ºå­¤å„¿è¿›ç¨‹ ï¼ˆOrphan Processï¼‰**ã€‚ 
* æ¯å½“å‡ºç°ä¸€ä¸ªå­¤å„¿è¿›ç¨‹çš„æ—¶å€™ï¼Œå†…æ ¸å°±æŠŠå­¤å„¿è¿›ç¨‹çš„çˆ¶è¿›ç¨‹è®¾ç½®ä¸º **init** ï¼Œè€Œ init  è¿›ç¨‹ä¼šå¾ªç¯åœ° `wait()` å®ƒçš„å·²ç»é€€å‡ºçš„å­è¿›ç¨‹ã€‚è¿™æ ·ï¼Œå½“ä¸€ä¸ªå­¤å„¿è¿›ç¨‹å‡„å‡‰åœ°ç»“æŸäº†å…¶ç”Ÿå‘½å‘¨æœŸçš„æ—¶å€™ï¼Œ**<font color="red">init è¿›ç¨‹å°±ä¼šä»£è¡¨å…šå’Œæ”¿åºœå‡ºé¢å¤„ç†å®ƒçš„ä¸€åˆ‡å–„åå·¥ä½œ</font>**ã€‚ 
* å› æ­¤å­¤å„¿è¿›ç¨‹å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå±å®³ã€‚

```c
#include <sys/types.h>
#include <unistd.h>
#include <stdio.h>

int main()
{
    pid_t pid = fork();

    // åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹
    if (pid > 0)
    {
        printf("i am parent process, pid : %d, ppid : %d\n", getpid(), getppid());
    }
    else if (pid == 0)
    {
        //æ³¨æ„æˆ‘ä»¬è¿™é‡Œçš„sleep å¦‚æœå†™åˆ°ä¸‹é¢è¾“å‡ºè¯­å¥çš„ä¸‹é¢ï¼Œé‚£è¾“å‡ºçš„çˆ¶è¿›ç¨‹idå°±ä¸ä¸€å®šæ˜¯1äº†ï¼Œå› ä¸ºä»–åœ¨è¾“å‡ºæ—¶ï¼Œå‡¯å—çˆ¶è¿›ç¨‹è¿˜æ²¡æ­»äº¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å†™åˆ°è¾“å‡ºè¯­å¥ä¸Šé¢
        sleep(1);
        // å½“å‰æ˜¯å­è¿›ç¨‹
        printf("i am child process, pid : %d, ppid : %d\n", getpid(), getppid());
    }
    // forå¾ªç¯
    for (int i = 0; i < 3; i++)
    {
        printf("i : %d, pid : %d\n", i, getpid());
    }
    return 0;
}
```

![å­¤å„¿è¿›ç¨‹](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/å­¤å„¿è¿›ç¨‹.69fbkflehzg0.webp)

* ğŸª€ï¼šå¯ä»¥çœ‹åˆ°äº§ç”Ÿäº†å­¤å„¿è¿›ç¨‹ï¼›
  * å­¤å„¿è¿›ç¨‹ä¼šè¢«å†…æ ¸åˆ†é…ç»™è¿›ç¨‹å·ä¸º1çš„è¿›ç¨‹ï¼ˆinitè¿›ç¨‹ï¼‰ï¼Œç”±è¿›ç¨‹å·ä¸º1çš„è¿›ç¨‹å»å›æ”¶è¿›ç¨‹å·ä¸º1çš„èµ„æºã€‚
* ğŸŸ¨ï¼šä¹‹æ‰€ä»¥å‡ºç°é»„è‰²è¿™é‡Œæ˜¾ç¤ºå®Œç»ˆç«¯åï¼Œåˆè·Ÿç€æ˜¾ç¤ºå­è¿›ç¨‹è¾“å‡ºçš„å†…å®¹æ˜¯å› ä¸ºï¼š
  * è¿è¡Œå¯æ‰§è¡Œç¨‹åºä¸€èˆ¬ä¼šé»˜è®¤åˆ‡æ¢åˆ°åå°å»è¿è¡Œï¼Œå½“æœ‰è¾“å‡ºæ—¶å®ƒåˆä¼šæŠŠå†…å®¹è¾“å‡ºåˆ°å‰å°(ç»ˆç«¯)ï¼Œå½“çˆ¶è¿›ç¨‹æ­»äº¡ä»¥åï¼Œæˆ‘ä»¬çˆ¶è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼ˆç»ˆç«¯ï¼‰å°±çŸ¥é“äº†ï¼Œçˆ¶è¿›ç¨‹å·²ç»è¿è¡Œå®Œæ¯•äº†ï¼Œæ‰€ä»¥å°±è¦åˆ‡æ¢å›å‰å°ï¼Œå°±ä¼šæ˜¾ç¤ºå‡ºğŸŸ¨çš„å†…å®¹ï¼Œä½†æ˜¯æ­¤æ—¶ï¼Œå­è¿›ç¨‹è¿˜æ²¡ç»“æŸï¼Œæ‰€ä»¥å°±ç»§ç»­æ‰§è¡Œå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¹ŸæŠŠä»–çš„è¾“å‡ºæ‰“å°åˆ°äº†å½“å‰ç»ˆç«¯

### 2.1 æ€è€ƒ

> * ä¸ºä»€ä¹ˆå­è¿›ç¨‹æ˜¯æ‰“å°åˆ°å½“å‰çš„ç»ˆç«¯ï¼Ÿ
> * åŸå› ï¼š
>   * å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å†…æ ¸åŒºæŸäº›æ•°æ®ä¹Ÿæ˜¯å…±äº«çš„ï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ï¼Œæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œè€Œæ–‡ä»¶æè¿°ç¬¦è¡¨çš„å‰3ä¸ªå¯¹åº”çš„æ ‡å¿—è¾“å…¥(0),æ ‡å‡†è¾“å‡º(1)ï¼Œæ ‡å‡†è¾“å…¥(2)æŒ‡å‘çš„éƒ½æ˜¯å½“å‰ç»ˆç«¯ï¼Œå°±æ˜¯çˆ¶è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œæ‰€ä»¥ï¼Œå­è¿›ç¨‹çš„è¾“å‡ºä¹Ÿæ˜¯åœ¨å½“å‰ç»ˆç«¯é‡Œ

## 3ã€åƒµå°¸è¿›ç¨‹

* **æ¯ä¸ªè¿›ç¨‹ç»“æŸä¹‹å, éƒ½ä¼šé‡Šæ”¾è‡ªå·±åœ°å€ç©ºé—´ä¸­çš„ç”¨æˆ·åŒºæ•°æ®ï¼Œå†…æ ¸åŒºçš„ PCB æ²¡æœ‰åŠæ³•è‡ªå·±é‡Šæ”¾æ‰ï¼Œéœ€è¦çˆ¶è¿›ç¨‹å»é‡Šæ”¾**ã€‚ 
* **è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œçˆ¶è¿›ç¨‹å°šæœªå›æ”¶ï¼Œå­è¿›ç¨‹æ®‹ç•™èµ„æºï¼ˆPCBï¼‰å­˜æ”¾äºå†…æ ¸ä¸­ï¼Œå˜æˆåƒµå°¸ ï¼ˆZombieï¼‰è¿›ç¨‹**ã€‚ 
* åƒµå°¸è¿›ç¨‹ä¸èƒ½è¢« kill -9 æ€æ­»ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœçˆ¶è¿›ç¨‹ä¸è°ƒç”¨ wait()  æˆ– waitpid() çš„è¯ï¼Œé‚£ä¹ˆä¿ç•™çš„é‚£æ®µä¿¡æ¯å°±ä¸ä¼šé‡Šæ”¾ï¼Œå…¶**è¿›ç¨‹å·å°±ä¼šä¸€ç›´è¢«å ç”¨**ï¼Œ ä½†æ˜¯ç³»ç»Ÿæ‰€èƒ½ä½¿ç”¨çš„è¿›ç¨‹å·æ˜¯æœ‰é™çš„ï¼Œå¦‚æœ**å¤§é‡çš„äº§ç”Ÿåƒµå°¸è¿›ç¨‹**ï¼Œå°†å› ä¸º**æ²¡æœ‰å¯ç”¨çš„è¿›ç¨‹å·**è€Œå¯¼è‡´ç³»ç»Ÿ**ä¸èƒ½äº§ç”Ÿæ–°çš„è¿›ç¨‹**ï¼Œæ­¤å³ä¸ºåƒµå°¸è¿›ç¨‹çš„å±å®³ï¼Œåº”å½“é¿å…ã€‚

```c
//zombie.c
#include <sys/types.h>
#include <unistd.h>
#include <stdio.h>

int main()
{
    pid_t pid = fork();

    // åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹
    if (pid > 0)
    {
        while (1)
        {
            printf("i am parent process, pid : %d, ppid : %d\n", getpid(), getppid());
            sleep(1);
        }
    }
    else if (pid == 0)
    {
        // å½“å‰æ˜¯å­è¿›ç¨‹
        printf("i am child process, pid : %d, ppid : %d\n", getpid(), getppid());
    }
    // forå¾ªç¯
    for (int i = 0; i < 3; i++)
    {
        printf("i : %d, pid : %d\n", i, getpid());
    }
    return 0;
}
```

![åƒµå°¸è¿›ç¨‹](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/åƒµå°¸è¿›ç¨‹.2moxsqy1mt00.webp)

* æ‰§è¡Œ `./zombie` åå­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹

* ä½¿ç”¨ `kill 9 åƒµå°¸è¿›ç¨‹id `æ²¡åŠæ³•ç›´æ¥æ€æ­»åƒµå°¸è¿›ç¨‹
* ä¸è°ƒç”¨wait() he waitpid() å‡½æ•°å›æ”¶åƒµå°¸è¿›ç¨‹æ–¹æ³•ï¼š
  * **æ€æ­»åƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œè®©åƒµå°¸è¿›ç¨‹æ‰˜ç®¡ç»™è¿›ç¨‹å·ä¸º1çš„è¿›ç¨‹ï¼Œç”±è¿›ç¨‹å·ä¸º1çš„è¿›ç¨‹å›æ”¶åƒµå°¸è¿›ç¨‹çš„èµ„æº**ï¼›
    * 1. æ‰‹åŠ¨`ctrl+c` ç»ˆæ­¢è¿›ç¨‹
      2. `kill -9 åƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹id` æ€æ­»çˆ¶è¿›ç¨‹



## 4ã€wait å‡½æ•°

```c
#include <sys/types.h>
#include <sys/wait.h>
pid_t wait(int *wstatus);
    åŠŸèƒ½ï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸï¼Œå¦‚æœä»»æ„ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸäº†ï¼Œæ­¤å‡½æ•°ä¼šå›æ”¶å­è¿›ç¨‹çš„èµ„æºã€‚
    æ³¨æ„: ä¸€æ¬¡åªèƒ½å›æ”¶ä¸€ä¸ªå­è¿›ç¨‹ã€‚
    å‚æ•°ï¼šint *wstatus
        è¿›ç¨‹é€€å‡ºæ—¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªintç±»å‹çš„åœ°å€ï¼Œä¼ å‡ºå‚æ•°
    è¿”å›å€¼ï¼š
        -æˆåŠŸ: è¿”å›è¢«å›æ”¶çš„å­è¿›ç¨‹çš„id
        -å¤±è´¥ï¼š -1ï¼ˆæ‰€æœ‰å­è¿›ç¨‹éƒ½ç»“æŸï¼Œæ²¡æœ‰å­è¿›ç¨‹éœ€è¦å›æ”¶æˆ–è°ƒç”¨å‡½æ•°å¤±è´¥ï¼‰
//è°ƒç”¨waitå‡½æ•°çš„è¿›ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ˆé˜»å¡ï¼‰ï¼Œç›´åˆ°å®ƒçš„ä¸€ä¸ªå­è¿›ç¨‹é€€å‡ºæˆ–è€…æ”¶åˆ°ä¸€ä¸ªä¸èƒ½è¢«å¿½ç•¥çš„ä¿¡å·æ—¶æ‰è¢«å”¤é†’ï¼ˆç›¸å½“äºç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼‰
//å¦‚æœæ²¡æœ‰å­è¿›ç¨‹ï¼Œå‡½æ•°ç«‹åˆ»è¿”å›ï¼Œè¿”å›-1ï¼›å¦‚æœå­è¿›ç¨‹éƒ½å·²ç»ç»“æŸäº†ï¼Œä¹Ÿä¼šç«‹å³è¿”å›ï¼Œè¿”å›-1
```

```c
//wait.c
#include <sys/types.h>
#include <sys/wait.h>
#include <stdio.h>
#include <unistd.h>

int main()
{
    // æœ‰ä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œåˆ›å»º5ä¸ªå­è¿›ç¨‹ï¼ˆå…„å¼Ÿï¼‰
    pid_t pid;

    // åˆ›å»º5ä¸ªå­è¿›ç¨‹
    for (int i = 0; i < 5; i++)
    {
        pid = fork();
        if (pid == 0) // è¿™æ ·å­è¿›ç¨‹å°±ä¸ä¼šå»è°ƒç”¨ fork() å»äº§ç”Ÿå­™å­è¿›ç¨‹
        {
            break;
        }
    }

    if (pid > 0)
    {
        // çˆ¶è¿›ç¨‹
        while (1)
        {
            printf("parent, pid = %d\n", getpid());
            // wait å‚æ•°å†™ NULLè¡¨ç¤ºæˆ‘ä»¬ä¸éœ€è¦è·å¾—å­è¿›ç¨‹é€€å‡ºçš„çŠ¶æ€
            int ret = wait(NULL);

            // if(ret == -1){
            //     break;
            // }

            printf("child die, pid = %d\n", ret);

            sleep(1);
        }
    }
    else if (pid == 0)
    {
        // å­è¿›ç¨‹
        while (1)
        {
            printf("child, pid = %d\n", getpid());
            sleep(1);
        }
    }
    return 0;
}
```

![wait()å‡½æ•°1](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/wait()å‡½æ•°1.33ejxvgc1ew0.webp)

* å·¦ä¸Šè§’ï¼Œæ˜¯åœ¨`ç»ˆç«¯1` è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ `wait`
  * å¯ä»¥çœ‹åˆ°ç¨‹åºåœ¨æ‰§è¡Œå®Œä¸€æ¬¡çˆ¶è¿›ç¨‹åˆ° wait() å‡½æ•°æ—¶ï¼Œå°±è¢«é˜»å¡äº†
* å·¦ä¸‹å›¾æ˜¯ï¼Œåœ¨`ç»ˆç«¯2`é‡Œ**æŸ¥çœ‹è¿›ç¨‹**ï¼Œè¿˜æœ‰**æ€æ­»è¿›ç¨‹**
  * æ€æ­» 13269 å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹çš„wait()å°±ä¼šå›æ”¶è¯¥è¿›ç¨‹çš„èµ„æºï¼Œå¦‚æœæ²¡æœ‰waitå‡½æ•°å»å›æ”¶èµ„æºï¼Œå°±æ€ä¸æ­»è¯¥è¿›ç¨‹ ã€‚ã€‚ã€‚å…¶ä»–è¿›ç¨‹ä¹Ÿç›¸åŒğŸ±â€ğŸ‰
  * å­è¿›ç¨‹éƒ½è¢«æ€æ­»åï¼Œçˆ¶è¿›ç¨‹çš„ `wait()` å‡½æ•°è¿”å›å€¼ä¸º `-1`ğŸª€ï¼›

* å¦‚æœè¦åœ¨æ²¡æœ‰å­è¿›ç¨‹åçˆ¶è¿›ç¨‹ä¹Ÿç»“æŸï¼Œä¸Šé¢çˆ¶è¿›ç¨‹ä»£ç é‡Œè¦åœ¨åŠ è¿™ä¸ªåˆ¤æ–­ä»£ç ï¼š

```c
...
int ret = wait(NULL);   
if(ret == -1){
   break;
}
...
```



### 4.1 é€€å‡ºä¿¡æ¯ç›¸å…³å®å‡½æ•°

> * WIFEXITED(status) é0ï¼Œè¿›ç¨‹æ­£å¸¸é€€å‡º 
> * WEXITSTATUS(status) å¦‚æœä¸Šå®ä¸ºçœŸï¼Œè·å–è¿›ç¨‹é€€å‡ºçš„çŠ¶æ€ï¼ˆexitçš„å‚æ•°ï¼‰ 
>
> 
>
> * WIFSIGNALED(status) é0ï¼Œè¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢ 
> * WTERMSIG(status) å¦‚æœä¸Šå®ä¸ºçœŸï¼Œè·å–ä½¿è¿›ç¨‹ç»ˆæ­¢çš„ä¿¡å·ç¼–å· 
>
> 
>
> * WIFSTOPPED(status) é0ï¼Œè¿›ç¨‹å¤„äºæš‚åœçŠ¶æ€ 
> * WSTOPSIG(status) å¦‚æœä¸Šå®ä¸ºçœŸï¼Œè·å–ä½¿è¿›ç¨‹æš‚åœçš„ä¿¡å·çš„ç¼–å· 
> * WIFCONTINUED(status) é0ï¼Œè¿›ç¨‹æš‚åœåå·²ç»ç»§ç»­è¿è¡Œ

```c
#include <sys/types.h>
#include <sys/wait.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

int main()
{
    // æœ‰ä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œåˆ›å»º5ä¸ªå­è¿›ç¨‹ï¼ˆå…„å¼Ÿï¼‰
    pid_t pid;

    // åˆ›å»º5ä¸ªå­è¿›ç¨‹
    for (int i = 0; i < 5; i++)
    {
        pid = fork();
        if (pid == 0) // è¿™æ ·å­è¿›ç¨‹å°±ä¸ä¼šå»è°ƒç”¨ fork() å»äº§ç”Ÿå­™å­è¿›ç¨‹
        {
            break;
        }
    }

    if (pid > 0)
    {
        // çˆ¶è¿›ç¨‹
        while (1)
        {
            printf("parent, pid = %d\n", getpid());
            // wait å‚æ•°å†™ NULLè¡¨ç¤ºæˆ‘ä»¬ä¸éœ€è¦è·å¾—å­è¿›ç¨‹é€€å‡ºçš„çŠ¶æ€
            int st;
            int ret = wait(&st);

            if (ret == -1)
            {
                break;
            }

            if (WIFEXITED(st))
            {
                // æ˜¯ä¸æ˜¯æ­£å¸¸é€€å‡º
                printf("é€€å‡ºçš„çŠ¶æ€ç ï¼š%d\n", WEXITSTATUS(st));
            }
            if (WIFSIGNALED(st))
            {
                // æ˜¯ä¸æ˜¯å¼‚å¸¸ç»ˆæ­¢
                printf("è¢«å“ªä¸ªä¿¡å·å¹²æ‰äº†ï¼š%d\n", WTERMSIG(st));
            }

            printf("child die, pid = %d\n", ret);

            sleep(1);
        }
    }
    else if (pid == 0)
    {
        // å­è¿›ç¨‹
        //while (1)
        //{   
        //}
        printf("child, pid = %d\n", getpid());
        sleep(1);
        exit(0);
    }
    return 0;
}
```

* å¦‚æœæŠŠä¸Šé¢ä»£ç çš„ exit(0) æ”¹æˆ exit(1)å°±æ˜¯ä¸‹å›¾å·¦è¾¹çš„æ˜¾ç¤ºï¼Œå¦‚æœä¸º0ï¼Œå°±æ˜¯å³è¾¹çš„æ˜¾ç¤º

![é€€å‡ºä¿¡æ¯ç›¸å…³å®1](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/é€€å‡ºä¿¡æ¯ç›¸å…³å®1.2cy0h0zb4dc0.webp)

```c
//å°†ä¸Šé¢ä»£ç çš„å­ç¨‹åºä»£ç ä¿®æ”¹å¦‚ä¸‹
else if (pid == 0){
        // å­è¿›ç¨‹
         while(1) {
            printf("child, pid = %d\n",getpid());    
            sleep(1);       
         }
        exit(0);
    }
```

![é€€å‡ºä¿¡æ¯ç›¸å…³å®2](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/é€€å‡ºä¿¡æ¯ç›¸å…³å®2.5bokjw0io500.webp)



## 5ã€waitpid å‡½æ•°

```c
#include <sys/types.h>
#include <sys/wait.h>
pid_t waitpid(pid_t pid, int *wstatus, int options);
    åŠŸèƒ½ï¼šå›æ”¶æŒ‡å®šè¿›ç¨‹å·çš„å­è¿›ç¨‹ï¼Œå¯ä»¥è®¾ç½®æ˜¯å¦é˜»å¡ã€‚
    å‚æ•°ï¼š
        -pidï¼š
            pid > 0 : æŸä¸ªå­è¿›ç¨‹çš„id
            pid = 0 ï¼šå›æ”¶å½“å‰è¿›ç¨‹ç»„çš„æ‰€æœ‰å­è¿›ç¨‹
            pid = -1 : å›æ”¶ä»»æ„çš„å­è¿›ç¨‹ï¼Œç›¸å½“äº wait()  ï¼ˆæœ€å¸¸ç”¨ï¼‰
            pid < -1 : å›æ”¶æŸä¸ªè¿›ç¨‹ç»„çš„ç»„idçš„ç»å¯¹å€¼ï¼Œå›æ”¶æŒ‡å®šè¿›ç¨‹ç»„ä¸­çš„å­è¿›ç¨‹
        -int *wstatus
        	è¿›ç¨‹é€€å‡ºæ—¶çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ªintç±»å‹çš„åœ°å€ï¼Œä¼ å‡ºå‚æ•°
        	
        - optionsï¼šè®¾ç½®é˜»å¡æˆ–è€…éé˜»å¡
            0 ï¼š é˜»å¡
            WNOHANG ï¼šéé˜»å¡

        - è¿”å›å€¼ï¼š
            > 0 : è¿”å›å­è¿›ç¨‹çš„id
            = 0 ï¼š options = WNOHANGæ—¶æ‰å¯èƒ½è¿”å›ç­‰äº0ï¼Œè¡¨ç¤ºè¿˜æœ‰å­è¿›ç¨‹æ´»ç€
            = -1 ï¼šé”™è¯¯ï¼Œæˆ–è€…æ²¡æœ‰å­è¿›ç¨‹äº†
```

### 5.1 é˜»å¡

```c
#include <sys/types.h>
#include <sys/wait.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

int main()
{

    // æœ‰ä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œåˆ›å»º5ä¸ªå­è¿›ç¨‹ï¼ˆå…„å¼Ÿï¼‰
    pid_t pid;

    // åˆ›å»º5ä¸ªå­è¿›ç¨‹
    for (int i = 0; i < 5; i++)
    {
        pid = fork();
        if (pid == 0) // è¿™æ ·å­è¿›ç¨‹å°±ä¸ä¼šå»è°ƒç”¨ fork() å»äº§ç”Ÿå­™å­è¿›ç¨‹
        {
            break;
        }
    }

    if (pid > 0)
    {
        // çˆ¶è¿›ç¨‹
        while (1)
        {
            printf("parent, pid = %d\n", getpid());
            // wait å‚æ•°å†™ NULLè¡¨ç¤ºæˆ‘ä»¬ä¸éœ€è¦è·å¾—å­è¿›ç¨‹é€€å‡ºçš„çŠ¶æ€
            int st;
            //waitpid(-1, &st, 0) é˜»å¡å›æ”¶æ‰€æœ‰çš„å­è¿›ç¨‹ï¼Œç›¸å½“äº wait() 
            int ret = waitpid(-1, &st, 0);

            if (ret == -1)
            { break; }

            if (WIFEXITED(st))
            {
                // æ˜¯ä¸æ˜¯æ­£å¸¸é€€å‡º
                printf("é€€å‡ºçš„çŠ¶æ€ç ï¼š%d\n", WEXITSTATUS(st));
            }
            if (WIFSIGNALED(st))
            {
                // æ˜¯ä¸æ˜¯å¼‚å¸¸ç»ˆæ­¢
                printf("è¢«å“ªä¸ªä¿¡å·å¹²æ‰äº†ï¼š%d\n", WTERMSIG(st));
            }
            printf("child die, pid = %d\n", ret);
            sleep(1);
        }
    }
    else if (pid == 0)
    {
        // å­è¿›ç¨‹
        while (1)
        {
            printf("child, pid = %d\n", getpid());
            sleep(1);
        }
        exit(0);
    }
    return 0;
}
```

* æ‰§è¡Œå‡ºæ¥çš„ç»“æœå’Œä¸Šé¢é‚£ä¸ªé€€å‡ºä¿¡æ¯ç›¸å…³å®å‡½æ•°æ˜¯ä¸€æ ·çš„ï¼Œå…¶å®ä»£ç é™¤äº†waitpidé‚£å¥ä¸ä¸€æ ·å…¶ä»–ä¹Ÿä¸€æ ·ï¼Œæ‰€ä»¥ç›´æ¥ç”¨äº†ä¸Šé¢çš„è¿è¡Œæˆªå›¾

![é€€å‡ºä¿¡æ¯ç›¸å…³å®2](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/é€€å‡ºä¿¡æ¯ç›¸å…³å®2.5bokjw0io500.webp)



### 5.2 éé˜»å¡

```c
#include <sys/types.h>
#include <sys/wait.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

int main()
{

    // æœ‰ä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œåˆ›å»º5ä¸ªå­è¿›ç¨‹ï¼ˆå…„å¼Ÿï¼‰
    pid_t pid;

    // åˆ›å»º5ä¸ªå­è¿›ç¨‹
    for (int i = 0; i < 5; i++)
    {
        pid = fork();
        if (pid == 0) // è¿™æ ·å­è¿›ç¨‹å°±ä¸ä¼šå»è°ƒç”¨ fork() å»äº§ç”Ÿå­™å­è¿›ç¨‹
        {
            break;
        }
    }

    if (pid > 0)
    {
        // çˆ¶è¿›ç¨‹
        while (1)
        {
            printf("parent, pid = %d\n", getpid());
            // çœ‹ä¹‹å‰çš„ä»£ç ä¼šå‘ç°sleep(1)å†™åœ¨çˆ¶è¿›ç¨‹å‡½æ•°çš„æœ€ä¸‹é¢ï¼Œè¿™é‡Œå†™åˆ°å‰é¢æ˜¯å› ä¸ºï¼š
            // æˆ‘ä»¬ç°åœ¨æ˜¯éé˜»å¡çš„ï¼Œå¦‚æœå†™åˆ°ä¸‹é¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬çˆ¶è¿›ç¨‹å› ä¸ºä¸€ç›´åœ¨å¾ªç¯ï¼Œä¼šä¸€ç›´è¾“å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠsleepå†™åˆ°ä¸Šé¢æ¥æ”¾æ…¢è¾“å‡ºé€Ÿåº¦
            sleep(1);
            // wait å‚æ•°å†™ NULLè¡¨ç¤ºæˆ‘ä»¬ä¸éœ€è¦è·å¾—å­è¿›ç¨‹é€€å‡ºçš„çŠ¶æ€
            int st;
            int ret = waitpid(-1, &st, WNOHANG);

            if (ret == -1)
            {
                break;
            }
            // éé˜»å¡ï¼Œä»£ç ä¼šä¸€ç›´å¾€ä¸‹æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸‹é¢è¿™ä¸ªåˆ¤æ–­
            else if (ret == 0)
            {
                // è¯´æ˜è¿˜æœ‰å­è¿›ç¨‹å­˜åœ¨
                continue;
            }

            // å¦‚æœæ²¡æœ‰ä¸Šé¢é‚£ä¸ªï¼ˆret == 0ï¼‰çš„åˆ¤æ–­ï¼Œé‚£ä¹ˆä¸‹é¢è¿™ä¸ªret >0 åˆ¤æ–­è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„
            // å› ä¸ºå¦‚æœä¸åˆ¤æ–­å°±ç›´æ¥æ‰§è¡Œé‡Œé¢çš„å‡½æ•°ï¼Œé‚£ä¹ˆæ¯æ¬¡å¾ªç¯éƒ½ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç 
            // å¦‚æœæœ‰ä¸Šé¢çš„ï¼ˆret==0ï¼‰å°±è·³å‡ºæœ¬æ¬¡å¾ªç¯çš„åˆ¤æ–­ï¼Œé‚£è¿™é‡Œä¸åˆ¤æ–­ä¹Ÿä¸€æ ·
            // å»ºè®®è¿˜æ˜¯éƒ½å†™åˆ¤æ–­å§ï¼Œå¯è¯»æ€§æ¯”è¾ƒå¥½ï¼Œå¯ä»¥ä¸€çœ¼çœ‹å‡ºä¸åŒè¿”å›å€¼çš„æƒ…å†µ
            else if (ret > 0)
            {
                if (WIFEXITED(st))
                {
                    // æ˜¯ä¸æ˜¯æ­£å¸¸é€€å‡º
                    printf("é€€å‡ºçš„çŠ¶æ€ç ï¼š%d\n", WEXITSTATUS(st));
                }
                if (WIFSIGNALED(st))
                {
                    // æ˜¯ä¸æ˜¯å¼‚å¸¸ç»ˆæ­¢
                    printf("è¢«å“ªä¸ªä¿¡å·å¹²æ‰äº†ï¼š%d\n", WTERMSIG(st));
                }

                printf("child die, pid = %d\n", ret);
            }
        }
    }
    else if (pid == 0)
    {
        // å­è¿›ç¨‹
        while (1)
        {
            printf("child, pid = %d\n", getpid());
            sleep(1);
        }
        exit(0);
    }
    return 0;
}
```

![éé˜»å¡waitpidå‡½æ•°](https://cdn.staticaly.com/gh/JackCin877/image-hosting@master/Linux/éé˜»å¡waitpidå‡½æ•°.6ycx39gtkl80.webp)

* ğŸ§¡ï¼šå¯ä»¥çœ‹å‡ºçˆ¶è¿›ç¨‹æ²¡æœ‰è¢«é˜»å¡















